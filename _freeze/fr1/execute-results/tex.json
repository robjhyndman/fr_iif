{
  "hash": "1530af0bdb59d8585facd1823696c7f9",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Forecast reconciliation\nsubtitle: 1. Hierarchical time series & forecast reconciliation\nauthor: Rob J Hyndman\npdf-engine: latexmk\nfig-width: 9\nfig-height: 4.5\nformat:\n  beamer:\n    theme: monash\n    aspectratio: 169\n    fontsize: 14pt\n    section-titles: false\n    knitr:\n      opts_chunk:\n        dev: \"CairoPDF\"\ninclude-in-header: header.tex\ncite-method: biblatex\nbibliography: hts.bib\nbiblio-title: References\nhighlight-style: tango\nkeep-tex: true\nexecute:\n  echo: false\n  message: false\n  warning: false\n  cache: true\n---\n\n::: {.cell hash='fr1_cache/beamer/unnamed-chunk-1_be446bd6e813b2ede57ceeb235b2da58'}\n\n:::\n\n\n## Outline\n\n\\vspace*{0.7cm}\\tableofcontents\n\n# Hierarchical time series data\n\n## Labour market participation\n\\fontsize{13}{14}\\sf\n\\alert{Australia \\& New Zealand Standard Classification of Occupations}\n\\begin{itemize}\\tightlist\n\\item 8 major groups\n\\begin{itemize}\\tightlist\n\\item 43 sub-major groups\n\\begin{itemize}\\tightlist\n\\item 97 minor groups\n\n\\hspace*{1cm} 359 unit groups\n\n\\hspace*{2cm} 1023 occupations\n\\end{itemize}\\end{itemize}\\end{itemize}\\pause\n\n\\begin{block}{Example: statistician}\n\\begin{itemize}\n\\item[2] Professionals\n\\begin{itemize}\n\\item[22] Business, Human Resource and Marketing Professionals\n\\begin{itemize}\n\\item[224] Information and Organisation Professionals\n\n \\hspace*{1cm}2241 Actuaries, Mathematicians and Statisticians\n\n\\hspace*{2cm} 224113~~~Statistician\n\\end{itemize}\n\\end{itemize}\n\\end{itemize}\n\\end{block}\n\n## PBS sales\n\\placefig{0}{1}{width=16cm, height=200cm}{pills}\n\n## PBS sales\n\\alert{ATC drug classification}\\fontsize{11}{11}\\sffamily\n\n\\begin{tabular}{ll}\nA &Alimentary tract and metabolism\\\\\nB &Blood and blood forming organs\\\\\nC &Cardiovascular system\\\\\nD &Dermatologicals\\\\\nG &Genito-urinary system and sex hormones\\\\\nH &Systemic hormonal preparations, excluding sex hormones and insulins\\\\\nJ &Anti-infectives for systemic use\\\\\nL &Antineoplastic and immunomodulating agents\\\\\nM &Musculo-skeletal system\\\\\nN &Nervous system\\\\\nP &Antiparasitic products, insecticides and repellents\\\\\nR &Respiratory system\\\\\nS &Sensory organs\\\\\nV &Various\n\\end{tabular}\n\n## PBS sales\n\\alert{ATC drug classification}\\fontsize{11}{11}\\sffamily\n\n\\begin{minipage}{9.6cm}\n\\begin{tikzpicture}[level distance=13mm]\n\\tikzstyle{every node}=[ellipse,font=\\small,draw,fill=red!15,inner sep=0.1cm]\n\\tikzstyle[level font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 1}=[font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 2}=[font=\\small,set style={{every node}+=[fill=yellow]}]\n\\node[label=right:\\hspace*{-0.cm}Alimentary tract and metabolism,label=left:\\textbf{14 classes}\\hspace*{0.3cm}]{A}[edge from parent fork down]\n   child {node[label=right:\\hspace*{-0.0cm}Drugs used in diabetes,label=left:\\textbf{84 classes}]{A10}\n     child {node[label=right:\\hspace*{-0.35cm}Blood glucose lowering drugs]{A10B}\n       child {node[label=right:\\hspace*{0.1cm}Biguanides]{A10BA}\n         child {node[label=right:\\hspace*{-0.15cm}Metformin]{A10BA02}\n }}}};\n \\end{tikzpicture}\n\\end{minipage}\n\n## Spectacle sales\n\n\\placefig{7}{4.9}{width=8.7cm}{spectacles}\n\\begin{textblock}{12}(0.3,1.2)\n\\begin{itemize}\\tightlist\n    \\item Monthly UK sales data from 2000 -- 2014\n    \\item Provided by a large spectacle \\rlap{manufacturer}\n    \\item Split by brand (26), gender (3), price range (6), materials (4), and stores (600)\n    \\item About 1 million bottom-level series\n\\end{itemize}\n\\end{textblock}\n\n## Australian tourism regions\n\n\n::: {.cell hash='fr1_cache/beamer/ausmap_07a18b2bccceae1d0863799f3633adb4'}\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/ausmap-1.pdf)\n:::\n:::\n\n\n\\only<2>{\\begin{textblock}{6.5}(9.1,1.4)\n\\begin{block}{}%\\fontsize{12}{13}\\sf\n  \\begin{itemize}\\itemsep=0cm\\parskip=0cm\n    \\item Monthly data on visitor night from 1998 -- 2017\n    \\item From \\textit{National Visitor Survey}, annual interviews of 120,000 Australians aged 15+.\n    \\item Geographical hierarchy split by\n    \\begin{itemize}\n    \\item 7 states\n    \\item 27 zones\n    \\item 75 regions\n    \\end{itemize}\n  \\end{itemize}\n\\end{block}\n\\end{textblock}}\n\n\n## Australian tourism data\n\n\n::: {.cell hash='fr1_cache/beamer/tourism_plots_f7f4842262f22483222d77d50fb82b47'}\n\n:::\n\n\n\\only<1>{\\placefig{0.1}{1.4}{width=15.8cm}{tourism1}}\n\\only<2>{\\placefig{0.1}{1.4}{width=15.8cm}{tourism2}}\n\\only<3>{\\placefig{0.1}{1.4}{width=15.8cm}{tourism3}}\n\\only<4>{\\placefig{0.1}{1.4}{width=15.8cm}{tourism4}}\n\n## Hierarchical time series\n\\vspace*{-0.2cm}\n\nA \\alert{\\textbf{hierarchical time series}} is a collection of several time series that are linked together in a hierarchical structure.\n\n\\vspace*{-0.5cm}\n\\begin{center}\n\\begin{minipage}{9.6cm}\n\\begin{block}{}\n\\begin{tikzpicture}\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]\n\\tikzstyle[level distance=.1cm]\n\\tikzstyle[sibling distance=7cm]\n\\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AA}}\n   child {node {AB}}\n   child {node {AC}}\n }\n child {node {B}\n   child {node {BA}}\n   child {node {BB}}\n   child {node {BC}}\n }\n child {node {C}\n   child {node {CA}}\n   child {node {CB}}\n   child {node {CC}}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\\end{center}\n\n\\pause\\alert{Examples}\\vspace*{-0.4cm}\n\n * Tourism by state and region\n * Retail sales by product groups, sub groups, and SKUs\n\n## Grouped time series\n\nA \\alert{\\textbf{grouped time series}} is a collection of time series that can be grouped together in a number of non-hierarchical ways.\n\n\\vspace*{-0.2cm}\\begin{center}\n\\begin{minipage}{9.2cm}\n\\begin{block}{}\n\\begin{tikzpicture}[level distance=1.5cm]\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]\n\\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AX}}\n   child {node {AY}}\n }\n child {node {B}\n   child {node {BX}}\n   child {node {BY}}\n };\n\\end{tikzpicture}\\hspace*{1cm}\n\\begin{tikzpicture}[level distance=1.5cm]\n\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]\n\\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]\n\\node{Total}[edge from parent fork down]\n child {node {X}\n   child {node {AX}}\n   child {node {BX}}\n }\n child {node {Y}\n   child {node {AY}}\n   child {node {BY}}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\\end{center}\n\n\\pause\\alert{Examples}\\vspace*{-0.4cm}\n\n * Tourism by state and purpose of travel\n * Retail sales by product groups/sub groups, and by countries/regions\n\n## Hierarchical and grouped time series\n\n\\begin{textblock}{8.5}(0.2,1.5)\nEvery collection of time series with linear constraints can be written as\n\\centerline{\\colorbox[RGB]{210,210,210}{$\\bY_{t}=\\color{blue}\\bS\\color{red}\\bm{b}_{t}$}}\n\\vspace*{-0.9cm}\\begin{itemize}\\parskip=0cm\\itemsep=0cm\n\\item $\\by_t=$ vector of all series at time $t$\n\\item $ y_{\\text{Total},t}= $ aggregate of all series at time\n$t$.\n\\item $ y_{X,t}= $ value of series $X$ at time $t$.\n\\item $\\color{red}{\\bm{b}_t}=$ vector of most disaggregated series at time $t$\n\\item $\\color{blue}{\\bS}=$ ``summing matrix'' containing the linear constraints.\n\\end{itemize}\n\\end{textblock}\n\n\\begin{textblock}{5.7}(11.4,0.1)\n\\begin{minipage}{4cm}\n\\begin{block}{}\\centering\n\\begin{tikzpicture}\n\\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]\n\\tikzstyle[level distance=.3cm]\n\\tikzstyle[sibling distance=12cm]\n\\tikzstyle{level 1}=[sibling distance=10mm,font=\\small,set style={{every node}+=[fill=blue!15]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n }\n child {node {B}\n }\n child {node {C}\n };\n\\end{tikzpicture}\n\\end{block}\n\\end{minipage}\n\\end{textblock}\n\n\\begin{textblock}{5.7}(9.4,2.8)\\fontsize{14}{15}\\sf\n\\begin{align*}\n\\bY_{t}&= \\begin{pmatrix}\n  y_{\\text{Total},t}\\\\\n  y_{A,t}\\\\\n  y_{B,t}\\\\\n  y_{C,t}\n  \\end{pmatrix}  \\\\\n  &= {\\color{blue}\\underbrace{\\begin{pmatrix}\n                1 & 1 & 1 \\\\\n                1 & 0 & 0 \\\\\n                0 & 1 & 0\\\\\n                0 & 0 & 1\n                \\end{pmatrix}}_{\\bS}}\n     {\\color{red}\\underbrace{\\begin{pmatrix}\n       y_{A,t}\\\\y_{B,t}\\\\y_{C,t}\n       \\end{pmatrix}}_{\\bm{b}_{t}}}\n\\end{align*}\n\\end{textblock}\n\n## Hierarchical time series\n\n\\begin{block}{}\\hspace*{.6cm}{\\centering\\small\n\\begin{tikzpicture}[level distance=1cm]\n\\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]\n\\tikzstyle[level distance=.01cm]\n\\tikzstyle[sibling distance=12cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\scriptsize,set style={{every node}+=[fill=yellow]}]\n\\tikzstyle{level 1}=[sibling distance=40mm,font=\\footnotesize,set style={{every node}+=[fill=blue!15]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AX}}\n   child {node {AY}}\n   child {node {AZ}}\n }\n child {node {B}\n   child {node {BX}}\n   child {node {BY}}\n   child {node {BZ}}\n }\n child {node {C}\n   child {node {CX}}\n   child {node {CY}}\n   child {node {CZ}}\n };\n\\end{tikzpicture}}\n\\end{block}\\vspace*{0.1cm}\\pause\\fontsize{8}{8}\\sf\n\n\\hbox{$\\by_{t}= \\begin{pmatrix}\n    y_{\\text{Total},t}\\\\\n    y_{A,t}\\\\\n    y_{B,t}\\\\\n    y_{C,t}\\\\\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}=\n    {\\color{red}{\\begin{pmatrix}\n                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\\\\n                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\\\\n                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\\\\n             \\end{pmatrix}}}{\\color{blue}{\\begin{pmatrix}\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}}}$}\n\n\\only<3>{\\begin{textblock}{3}(10.5,8)\\fontsize{14}{15}\\sf\\colorbox[gray]{.8}{$\\by_{t}=\\color{red}\\bS\\color{blue}\\bm{b}_{t}$}\\end{textblock}}\n\n## Grouped data\n\n\\begin{block}{}\n\\begin{center}\\small\n\\tikzstyle{every node}=[inner sep=2pt]\n\\begin{tikzpicture}\n    \\matrix[ampersand replacement=\\&,column sep=0.3cm] {\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize,distance=1cm] {AX};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {AY};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {A}; \\\\[0.3cm]\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {BX};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {BY};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {B}; \\\\[0.3cm]\n        \\node[ellipse,draw,fill=blue!15] {X};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {Y};~ \\&\n        \\node[ellipse,draw,fill=red!15] {Total}; \\\\\n};\n\\end{tikzpicture}\n\\end{center}\n\\end{block}\\pause\\fontsize{10}{11}\\sf\n\n\\hbox{$\\by_{t}= \\begin{pmatrix}\n    y_{\\text{Total},t}\\\\\n    y_{A,t}\\\\\n    y_{B,t}\\\\\n    y_{X,t}\\\\\n    y_{Y,t}\\\\\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\n    \\end{pmatrix}=\n    \\color{red}\\begin{pmatrix}\n                1 & 1 & 1 & 1 \\\\\n                1 & 1 & 0 & 0 \\\\\n                0 & 0 & 1 & 1 \\\\\n                1 & 0 & 1 & 0 \\\\\n                0 & 1 & 0 & 1 \\\\\n                1 & 0 & 0 & 0 \\\\\n                0 & 1 & 0 & 0 \\\\\n                0 & 0 & 1 & 0 \\\\\n                0 & 0 & 0 & 1\n             \\end{pmatrix}\n    \\color{blue}\\begin{pmatrix}\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\n    \\end{pmatrix}$}\n\n\\vspace*{-1cm}\n\n\\only<3>{\\begin{textblock}{3}(10.5,8)\\fontsize{14}{15}\\sf\\colorbox[gray]{.8}{$\\by_{t}=\\color{red}\\bS\\color{blue}\\bm{b}_{t}$}\\end{textblock}}\n\n## The hierarchical forecasting problem\n\n* We want forecasts at all levels of aggregation.\n* If we model and forecast each series independently, the forecasts will almost certainly not add up.\n* We need to impose constraints on the forecasts to ensure they are \"coherent\".\n* We need to do this in a way that is computationally efficient.\n\n# Hierarchical forecasting using single-level approaches\n\n## Hierarchical forecasting 20 years ago\n\n\n::: {.cell hash='fr1_cache/beamer/pyramid_498bcd37ef97588b6cc4cf96e806eb8f'}\n\n:::\n\n\n\\placefig{0.3}{1.1}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism1}\n\\placefig{0.3}{3.7}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism2}\n\\placefig{0.3}{6.3}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism4}\n\\placefig{6}{1.2}{width=7.8cm, height=7.8cm}{pyramid}\n\n## Top-down forecasting\n\n\\begin{textblock}{7}(0.4,1.4)\n\\alert{Advantages}\n\\begin{itemize}\\tightlist\n    \\item Works well in presence of low counts.\n    \\item Single forecasting model easy to build\n    \\item Provides reliable forecasts for aggregate levels.\n\\end{itemize}\n\\end{textblock}\n\\begin{textblock}{7}(8,1.4)\n\\alert{Disadvantages}\n\\begin{itemize}\\tightlist\n    \\item Loss of information, especially individual series dynamics.\n    \\item Distribution of forecasts to lower levels can be difficult\n    \\item No prediction intervals\n\\end{itemize}\n\\end{textblock}\n\n## Bottom-up forecasting\n\n\\begin{textblock}{7}(0.4,1.4)\n\\alert{Advantages}\n\\begin{itemize}\\tightlist\n    \\item No loss of information.\n    \\item Better captures dynamics of\n    individual series.\n\\end{itemize}\n\\end{textblock}\n\\begin{textblock}{7}(8,1.4)\n\\alert{Disadvantages}\n\\begin{itemize}\\tightlist\n    \\item Large number of series to be forecast.\n    \\item Constructing forecasting models is harder because of noisy\n    data at bottom level.\n    \\item No prediction intervals\n\\end{itemize}\n\\end{textblock}\n\n## Forecasting notation\n\nLet $\\hat{\\bm{y}}_{T+h|T}$ be vector of initial $h$-step forecasts, made at time $T$, stacked in same order as $\\by_t$. (In general, they will not \"add up\".)\\pause\n\n\\begin{block}{}\nCoherent linear forecasts are of the form:\n\n\\centerline{$\\tilde{\\bm{y}}_{T+h|T}=\\bS\\bm{G}\\hat{\\bm{y}}_{T+h|T}$}\n\nfor some matrix $\\bm{G}$.\n\\end{block}\\pause\n\n* $\\bm{G}$ extracts and combines base forecasts $\\hat{\\bm{y}}_{T+h|T}$ to get bottom-level forecasts.\n* $\\bS$ adds them up\n\n## Bottom-up forecasting\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\tilde{\\bm{y}}_{T+h|T}=\\bS\\bm{G}\\hat{\\bm{y}}_{T+h|T}$}\n\\end{block}\n\nBottom-up forecasts are obtained using\n$$\n\\bm{G} = \\left[\\bm{0}\\mid \\bm{I}\\right],\n$$\nwhere $\\bm{0}$ is null matrix and $\\bm{I}$ is identity matrix.\n\\begin{itemize}\\tightlist\n\\item $\\bm{G}$ matrix extracts only bottom-level forecasts from $\\hat{\\bm{y}}_{T+h|T}$\n\\item $\\bS$ adds them up to give the bottom-up forecasts.\n\\end{itemize}\n\n## Top-down forecasting\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\tilde{\\bm{y}}_{T+h|T}=\\bS\\bm{G}\\hat{\\bm{y}}_{T+h|T}$}\n\\end{block}\n\nTop-down forecasts are obtained using\n$$\n\\bm{G}= \\left[\\bm{p}\\mid\\bm{0}\\right]\n$$\nwhere $\\bm{p}=[p_{1},p_{2},\\dots,p_{n_b}]'$ and $\\displaystyle\\sum_{k=1}^{n_b} p_k = 1$.\n\\begin{itemize}\\tightlist\n\\item $\\bm{G}$ distributes forecasts of aggregate to lowest level series.\n\\item Different methods of top-down forecasting lead to different proportionality vectors $\\bm{p}$.\n\\end{itemize}\n\n## Properties of single-level methods\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\tilde{\\bm{y}}_{t+h|t}=\\bS\\bG\\hat{\\bm{y}}_{t+h|t}$}\n\\end{block}\n\n\\begin{block}{Mean}\\vspace*{-0.8cm}\n\\begin{align*}\n\\E[\\tilde{\\by}_{T+h|T} \\mid \\by_1,\\dots,\\by_T]\n & = \\bm{S}\\bm{G}\\E[\\hat{\\by}_{T+h|T} \\mid \\by_1,\\dots,\\by_T] \\\\\n & = \\bm{S}\\E[\\bm{b}_{T+h|T} \\mid \\by_1,\\dots,\\by_T]\\\\[-1.2cm]\n\\end{align*}\nprovided $\\bS\\bG\\bS = \\bS$\nand $\\E[\\hat{\\by}_{T+h|T} \\mid \\by_1,\\dots,\\by_T] = \\bm{S}\\E[\\bm{b}_{T+h|T} \\mid \\by_1,\\dots,\\by_T]$.\ni.e., forecasts $\\tilde{\\bm{y}}_{T+h|T}$ are unbiased iff base forecasts $\\hat{\\bm{y}}_{T+h|T}$ are unbiased and $\\bS\\bG\\bS=\\bS$.\n\\end{block}\\pause\\vspace*{-0.3cm}\n\n* $\\bS\\bG\\bS = \\bS$ for bottom-up method\n* $\\bS\\bG\\bS \\ne \\bS$ for any top-down or middle-out method.\n\n\\vspace*{10cm}\n\n## Properties of single-level methods\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\tilde{\\bm{y}}_{t+h|t}=\\bS\\bG\\hat{\\bm{y}}_{t+h|t}$}\n\\end{block}\n\n\\begin{block}{Variance}\\vspace*{-0.8cm}\n\\begin{align*}\n\\bm{V}_h &= \\var[\\by_{T+h} - \\tilde{\\by}_{T+h|T}  \\mid \\by_1,\\dots,\\by_T] \\\\\n& = \\bS\\bG\\bm{W}_{h}\\bG'\\bS'\\\\[-1.2cm]\n\\end{align*}\nwhere $\\bm{W}_h = \\var[\\by_{T+h} - \\hat{\\by}_{T+h|T} \\mid \\by_1,\\dots,\\by_T]$\n\\end{block}\\pause\n\n* $\\bm{W}_h$ is hard to estimate for $h>1$.\n* This suggests we should choose $\\bm{G}$ to minimise $\\bm{V}_h$.\n\n\\vspace*{10cm}\n\n# Linear forecast reconciliation\n\n## Early history of forecast reconciliation\n\n\\begin{textblock}{15.4}(0.3,1.2)\n\\begin{block}{History}\\fontsize{12}{13}\\sf\n\\begin{multicols}{2}\n\\begin{description}[0000:]\\parskip=0cm\\itemsep=0.05cm\n\\item[2001:] Idea to use all available series to forecast Australia's labour market by occupation.\n\\item[2004:] PhD student Roman Ahmed begins, co-supervised with George Athanasopoulos.\n\\item[2006:] Presentation at ISF, Santander.\n\\item[2007:] Pre-print of ``Optimal combination forecasts for hierarchical time series''.\n\\item[2009:] Application to Australian tourism published in IJF.\n\\item[2010:] First version of hts package on CRAN.\n\\item[2011:] ``Optimal combination forecasts for hierarchical time series'' appears in CSDA.\n\\item[2019:] ``Optimal forecast reconciliation for hierarchical and grouped time series through trace minimization''' appears in JASA.\n\\end{description}\n\\end{multicols}\n\\end{block}\n\\end{textblock}\n\n## Forecast reconciliation research\n\n\n::: {.cell hash='fr1_cache/beamer/gs_searches_9d26624829649d0c988b5c5894d42e57'}\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/gs_searches-1.pdf)\n:::\n:::\n\n\n## Forecast reconciliation research\n\n\n::: {.cell hash='fr1_cache/beamer/isf_searches_d22e74153eaaf806bb87321daf6a69cc'}\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/isf_searches-1.pdf)\n:::\n:::\n\n\n## Linear forecast reconciliation\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\tilde{\\bm{y}}_{T+h|T}=\\bS\\bG\\hat{\\bm{y}}_{T+h|T}$}\n\\end{block}\\vspace*{-0.4cm}\n\\begin{itemize}\\tightlist\n\\item $\\bG$ combines base forecasts $\\hat{\\by}_{T+h|T}$ to get bottom-level forecasts.\n\\item $\\bS$ creates linear combinations.\n\\item Bottom-up and top-down can be seen as special cases.\n\\item $\\bS\\bG$ is a projection matrix iff $\\bS\\bG\\bS'=\\bS$.\n\\item Reconciled forecasts are unbiased iff base forecasts are unbiased and $\\bS\\bG$ is a projection.\n\\item $\\bm{V}_h = \\var[\\by_{T+h} - \\tilde{\\by}_{T+h|T}  \\mid \\by_1,\\dots,\\by_T] = \\bS\\bG\\bm{W}_{h}\\bG'\\bS'$\n\\item How to choose $\\bm{G}$ to create optimal forecasts?\n\\end{itemize}\n\n## Minimum trace reconciliation\n\n\\vspace*{0.2cm}\\begin{alertblock}{Minimum trace (MinT) reconciliation}\nIf $\\bS\\bG$ is a projection, then the trace of $\\bm{V}_h$ is minimized when\n\\centerline{$\\bG = (\\bS'\\bm{W}_h^{-1}\\bS)^{-1}\\bS'\\bm{W}_h^{-1}$}\n\\end{alertblock}\n\\begin{block}{}\n\\centerline{$\\displaystyle\\textcolor{red}{\\tilde{\\by}_{T+h|T}}\n=\\bS(\\bS'\\bm{W}_h^{-1}\\bS)^{-1}\\bS'\\bm{W}_h^{-1}\\textcolor{blue}{\\hat{\\by}_{T+h|T}}$}\n\\end{block}\\vspace*{-0.2cm}\n\\centerline{\\hspace*{1cm}\\textcolor{red}{Reconciled forecasts}\\hfill\\textcolor{blue}{Base forecasts}\\hspace*{2cm}}\\vspace*{-0.2cm}\n\n* Trace of $\\bm{V}_h$ is sum of forecast variances.\n* MinT solution is $L_2$ optimal amongst linear unbiased forecasts.\n* How to estimate $\\bm{W}_h = \\var[\\by_{T+h} - \\hat{\\by}_{T+h|T} \\mid \\by_1,\\dots,\\by_T]$?\n* Is $\\bm{W}_h \\approx k_h \\bm{W}_1$ a reasonable approximation?\n\n## Linear projections\n\n\\begin{textblock}{5}(7,-0.2)\n\\begin{block}{}\n\\centerline{$\\tilde{\\by}_{T+h|T}=\\bS\\bG\\hat{\\by}_{T+h|T}$}\n\\end{block}\n\\end{textblock}\n\n\\begin{textblock}{9.4}(.5,1.2)\n\\begin{alertblock}{Reconciliation method \\hspace*{0.5cm} $\\bG$}\n\\begin{tabular}{ll}\n  OLS             & $(\\bS'\\bS)^{-1}\\bS'$ \\\\\n  WLS(var)        & $(\\bS'\\bm{\\Lambda}_v\\bS)^{-1}\\bS'\\bm{\\Lambda}_v$ \\\\\n  WLS(struct)     & $(\\bS'\\bm{\\Lambda}_s\\bS)^{-1}\\bS'\\bm{\\Lambda}_s$ \\\\\n  MinT(sample)    & $(\\bS'\\hat{\\bm{W}}_{\\text{sam}}^{-1}\\bS)^{-1}\\bS' \\hat{\\bm{W}}_{\\text{sam}}^{-1}$  \\\\\n  MinT(shrink)\\hspace*{2cm}    & $(\\bS'\\hat{\\bm{W}}_{\\text{shr}}^{-1}\\bS)^{-1}\\bS' \\hat{\\bm{W}}_{\\text{shr}}^{-1}$  \\\\\n\\end{tabular}\n\\end{alertblock}\n\\end{textblock}\n\\begin{textblock}{15}(.2,5.7)\\fontsize{13}{15}\\sf\n\\begin{itemize}\\parskip=0cm\n\\item $\\bm{\\Lambda}_v = \\text{diag}(\\bm{W}_1)^{-1}$\n\\item $\\hat{\\bm{W}}_{\\text{sam}}$ is sample estimate of the residual covariance matrix\n\\item $\\hat{\\bm{W}}_{\\text{shr}}$ is shrinkage estimator $\\tau \\text{diag}(\\hat{\\bm{W}}_{\\text{sam}})+(1-\\tau)\\hat{\\bm{W}}_{\\text{sam}}$\\\\ where $\\tau$ selected optimally.\n\\item Still need a good estimate of $\\bm{W}_h$ for forecast variance.\n\\end{itemize}\n\\end{textblock}\n\\begin{textblock}{14}(4.5,5.7)\\fontsize{13}{15}\\sf\n\\begin{itemize}\\tightlist\n\\item $\\bm{\\Lambda}_s = \\text{diag}(\\bS\\bm{1})^{-1}$\n\\end{itemize}\n\\end{textblock}\n\\begin{textblock}{5}(10.3,3.35)\n\\begin{block}{}\nThese approximate MinT by assuming $\\bm{W}_h = k_h \\bm{W}_1$.\n\\end{block}\n\\end{textblock}\n\n## OLS is not as bad as you might think\n\n* If all base forecasts come from the same model, then forecast errors are coherent.\n* So $\\hat{\\bm{y}}_{T+h|T} = \\bm{S}\\hat{\\bm{b}}_{T+h|T} + \\bm{S}\\hat{\\bm{\\varepsilon}}_{T+h}$ and\n$$\n  \\bm{W}_h = \\var(\\bm{y}_{T+h} - \\hat{\\bm{y}}_{T+h|T}) = \\bm{S}\\bm{\\Sigma}_h\\bm{S}'\n$$\nwhere $\\bm{\\Sigma}_h = \\var(\\hat{\\bm{\\varepsilon}}_{T+h})$. So\n\\begin{align*}\n\\bG &= \\big[\\bS'\\bm{W}_h^{-1}\\bS\\big]^{-1}\\bS'\\bm{W}_h^{-1} \\\\\n    &= \\big[\\bS'(\\bm{S}\\bm{\\Sigma}_h\\bm{S}')^{-1}\\bS\\big]^{-1}\\bS'(\\bm{S}\\bm{\\Sigma}_h\\bm{S}')^{-1} \\\\\n    &= (\\bm{S}'\\bm{S})^{-1}\\bS'\\\\[-0.9cm]\n\\end{align*}\n\\rightline{(Proof: Hyndman et al, \\emph{CSDA} 2011)\\hspace*{1cm}}\n\n# Example: Australian tourism\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/tourismdata_7d535459d39fa2032539bacf854c5ac9'}\n\n```{.r .cell-code}\ntourism\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 18,000 x 5 [1M]\n# Key:       state, zone, region [75]\n      month state zone      region visitors\n      <mth> <chr> <chr>     <chr>     <dbl>\n 1 1998 Jan NSW   Metro NSW Sydney     926.\n 2 1998 Feb NSW   Metro NSW Sydney     647.\n 3 1998 Mar NSW   Metro NSW Sydney     716.\n 4 1998 Apr NSW   Metro NSW Sydney     621.\n 5 1998 May NSW   Metro NSW Sydney     598.\n 6 1998 Jun NSW   Metro NSW Sydney     601.\n 7 1998 Jul NSW   Metro NSW Sydney     720.\n 8 1998 Aug NSW   Metro NSW Sydney     645.\n 9 1998 Sep NSW   Metro NSW Sydney     633.\n10 1998 Oct NSW   Metro NSW Sydney     771.\n# i 17,990 more rows\n```\n\n\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/tourismagg_33af66c457c4b3e7de6295f9ddfce57b'}\n\n```{.r .cell-code}\ntourism_agg <- tourism |>\n  aggregate_key(state / zone / region, visitors = sum(visitors))\n```\n:::\n\n::: {.cell hash='fr1_cache/beamer/tourismagg2_3dd353931e9fac53f2d16bb7d4579a0d'}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tsibble: 26,400 x 5 [1M]\n# Key:       state, zone, region [110]\n      month state        zone         region       visitors\n      <mth> <chr*>       <chr*>       <chr*>          <dbl>\n 1 1998 Jan <aggregated> <aggregated> <aggregated>   10376.\n 2 1998 Feb <aggregated> <aggregated> <aggregated>    5746.\n 3 1998 Mar <aggregated> <aggregated> <aggregated>    7129.\n 4 1998 Apr <aggregated> <aggregated> <aggregated>    7939.\n 5 1998 May <aggregated> <aggregated> <aggregated>    6552.\n 6 1998 Jun <aggregated> <aggregated> <aggregated>    5969.\n 7 1998 Jul <aggregated> <aggregated> <aggregated>    7041.\n 8 1998 Aug <aggregated> <aggregated> <aggregated>    6382.\n 9 1998 Sep <aggregated> <aggregated> <aggregated>    6907.\n10 1998 Oct <aggregated> <aggregated> <aggregated>    7744.\n# i 26,390 more rows\n```\n\n\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/tourismmodels_39d67da778666c82b84c98129dd6ef29'}\n\n```{.r .cell-code}\nfit <- tourism_agg |>\n  filter(year(month) <= 2015) |>\n  model(ets = ETS(visitors))\n```\n:::\n\n::: {.cell hash='fr1_cache/beamer/tourismmodels1_821d90408da6c236a492d4bea9f5b86b'}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A mable: 110 x 4\n# Key:     state, zone, region [110]\n   state  zone            region                   ets\n   <chr*> <chr*>          <chr*>               <model>\n 1 NSW    ACT             Canberra        <ETS(M,N,A)>\n 2 NSW    ACT             <aggregated>    <ETS(M,N,A)>\n 3 NSW    Metro NSW       Central Coast   <ETS(M,N,M)>\n 4 NSW    Metro NSW       Sydney          <ETS(M,N,A)>\n 5 NSW    Metro NSW       <aggregated>    <ETS(M,N,A)>\n 6 NSW    North Coast NSW Hunter          <ETS(M,N,M)>\n 7 NSW    North Coast NSW North Coast NSW <ETS(M,N,M)>\n 8 NSW    North Coast NSW <aggregated>    <ETS(M,N,M)>\n 9 NSW    North NSW       Blue Mountains  <ETS(M,N,A)>\n10 NSW    North NSW       Central NSW     <ETS(M,N,M)>\n# i 100 more rows\n```\n\n\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism_35314a18a1211d20c2d285498a4b75e4'}\n\n```{.r .cell-code}\nfc <- fit |>\n  reconcile(\n    ols = min_trace(ets, method = \"ols\"),\n    wlsv = min_trace(ets, method = \"wls_var\"),\n    wlss = min_trace(ets, method = \"wls_struct\"),\n    # mint_c = min_trace(ets, method=\"mint_cov\"),\n    mint_s = min_trace(ets, method = \"mint_shrink\"),\n  ) |>\n  forecast(h = \"2 years\")\n```\n:::\n\n::: {.cell hash='fr1_cache/beamer/fctourism1_abf20bbc08c1523c5d08a2b1afa86a26'}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A fable: 13,200 x 7 [1M]\n# Key:     state, zone, region, .model [550]\n   state  zone   region   .model    month     visitors .mean\n   <chr*> <chr*> <chr*>   <chr>     <mth>       <dist> <dbl>\n 1 NSW    ACT    Canberra ets    2016 Jan N(202, 1437)  202.\n 2 NSW    ACT    Canberra ets    2016 Feb  N(160, 912)  160.\n 3 NSW    ACT    Canberra ets    2016 Mar N(204, 1489)  204.\n 4 NSW    ACT    Canberra ets    2016 Apr N(207, 1527)  207.\n 5 NSW    ACT    Canberra ets    2016 May N(196, 1380)  196.\n 6 NSW    ACT    Canberra ets    2016 Jun N(182, 1201)  182.\n 7 NSW    ACT    Canberra ets    2016 Jul N(207, 1562)  207.\n 8 NSW    ACT    Canberra ets    2016 Aug N(180, 1191)  180.\n 9 NSW    ACT    Canberra ets    2016 Sep N(194, 1390)  194.\n10 NSW    ACT    Canberra ets    2016 Oct N(220, 1777)  220.\n# i 13,190 more rows\n```\n\n\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism2_a49785026b730706ea9c8a641a99f266'}\n\n```{.r .cell-code}\nfc |>\n  filter(is_aggregated(state)) |>\n  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)\n```\n\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/fctourism2-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism3_f7b32018162a2fe9ef0176126baff299'}\n\n```{.r .cell-code}\nfc |>\n  filter(state == \"NSW\" & is_aggregated(zone)) |>\n  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)\n```\n\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/fctourism3-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism4_f181805e6054dfa55d193eb2b57eddf7'}\n\n```{.r .cell-code}\nfc |>\n  filter(region == \"Melbourne\") |>\n  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)\n```\n\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/fctourism4-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism5_926c929517781cc08bfd8b90ef77f8e7'}\n\n```{.r .cell-code}\nfc |>\n  filter(region == \"Snowy Mountains\") |>\n  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)\n```\n\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/fctourism5-1.pdf)\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fctourism6_92f07f44f2a1303f9004df4ed64ee58e'}\n\n```{.r .cell-code}\nfc |>\n  filter(region == \"Barossa\") |>\n  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)\n```\n\n::: {.cell-output-display}\n![](fr1_files/figure-beamer/fctourism6-1.pdf)\n:::\n:::\n\n\n## Performance evaluation\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\text{MASE} = \\text{mean}(|q_{j}|)$}\n$$\n  q_{j} = \\frac{e_{j}\\phantom{^2}}\n {\\displaystyle\\frac{1}{T-m}\\sum_{t=m+1}^T |y_{t}-y_{t-m}|}\n$$\n\\end{block}\n\n* $y_t=$ observation for period $t$\n* $e_{j}=$ forecast error for forecast horizon $j$\n* $T=$ size of training set\n* $m = 12$\n\n## Performance evaluation\n\n\\vspace*{0.2cm}\\begin{block}{}\n\\centerline{$\\text{RMSSE} = \\sqrt{\\text{mean}(q_{j}^2)}$}\n$$\n  q^2_{j} = \\frac{ e^2_{j}}\n {\\displaystyle\\frac{1}{T-m}\\sum_{t=m+1}^T (y_{t}-y_{t-m})^2}\n$$\n\\end{block}\n\n* $y_t=$ observation for period $t$\n* $e_{j}=$ forecast error for forecast horizon $j$\n* $T=$ size of training set\n* $m = 12$\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fcaccuracy_e5b10829615685caa95d168fe0106c2a'}\n\n```{.r .cell-code}\nfc |>\n  accuracy(tourism_agg, measures = list(mase = MASE, rmsse = RMSSE))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 550 x 7\n   .model state  zone            region          .type  mase rmsse\n   <chr>  <chr*> <chr*>          <chr*>          <chr> <dbl> <dbl>\n 1 ets    NSW    ACT             Canberra        Test  0.866 0.835\n 2 ets    NSW    ACT             <aggregated>    Test  0.866 0.835\n 3 ets    NSW    Metro NSW       Central Coast   Test  0.777 0.747\n 4 ets    NSW    Metro NSW       Sydney          Test  1.20  1.16 \n 5 ets    NSW    Metro NSW       <aggregated>    Test  1.18  1.18 \n 6 ets    NSW    North Coast NSW Hunter          Test  1.33  1.21 \n 7 ets    NSW    North Coast NSW North Coast NSW Test  0.845 0.884\n 8 ets    NSW    North Coast NSW <aggregated>    Test  1.11  1.02 \n 9 ets    NSW    North NSW       Blue Mountains  Test  1.02  1.02 \n10 ets    NSW    North NSW       Central NSW     Test  1.30  1.18 \n# i 540 more rows\n```\n\n\n:::\n:::\n\n\n## Example: Australian tourism\n\\fontsize{10}{11}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fcaccuracy2_c062785c5951e62d09306ff4744460e9'}\n\n```{.r .cell-code}\nfc |>\n  accuracy(tourism_agg, measures = list(mase = MASE, rmsse = RMSSE)) |>\n  group_by(.model) |>\n  summarise(mase = mean(mase), rmsse = sqrt(mean(rmsse^2))) |>\n  arrange(rmsse)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 x 3\n  .model  mase rmsse\n  <chr>  <dbl> <dbl>\n1 ols    0.930 0.926\n2 wlss   0.949 0.948\n3 mint_s 0.953 0.954\n4 wlsv   0.964 0.965\n5 ets    0.968 0.968\n```\n\n\n:::\n:::\n\n\n\\only<2>{\\begin{textblock}{7}(7,5)\n\\begin{block}{}\\fontsize{13}{14}\\sf\n\\begin{itemize}\\tightlist\n\\item Overall, every reconciliation method is better than the base ETS forecasts.\n\\end{itemize}\n\\end{block}\n\\end{textblock}}\n\n## Example: Australian tourism\n\\fontsize{8}{7}\\sf\n\n\n::: {.cell hash='fr1_cache/beamer/fcaccuracy3_4dd2173f3d4dce68f23911a61f2f3faa'}\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 20 x 4\n# Groups:   .model [5]\n   .model level     mase rmsse\n   <chr>  <fct>    <dbl> <dbl>\n 1 ets    National 1.44  1.27 \n 2 ols    National 1.46  1.29 \n 3 wlss   National 1.61  1.43 \n 4 mint_s National 1.64  1.45 \n 5 wlsv   National 1.69  1.49 \n 6 ols    State    1.07  1.08 \n 7 ets    State    1.10  1.11 \n 8 wlss   State    1.13  1.14 \n 9 mint_s State    1.15  1.15 \n10 wlsv   State    1.18  1.17 \n11 ols    Zone     0.954 0.948\n12 wlss   Zone     0.987 0.980\n13 mint_s Zone     0.995 0.988\n14 ets    Zone     1.01  0.999\n15 wlsv   Zone     1.01  1.00 \n16 ols    Region   0.901 0.895\n17 wlss   Region   0.910 0.907\n18 mint_s Region   0.911 0.911\n19 wlsv   Region   0.917 0.919\n20 ets    Region   0.935 0.938\n```\n\n\n:::\n:::\n\n\n\\only<2>{\\begin{textblock}{7}(7,5)\n\\begin{block}{}\\fontsize{13}{14}\\sf\n\\begin{itemize}\\tightlist\n\\item OLS is best for all levels except national.\n\\item Improvements due to reconciliation are greater at lower levels.\n\\end{itemize}\n\\end{block}\n\\end{textblock}}\n\n# Fast computational tricks\n\n## Fast computation: hierarchical data\n\n\\begin{block}{}\\hspace*{.6cm}{\\centering\\small\n\\begin{tikzpicture}[level distance=1cm]\n\\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]\n\\tikzstyle[level distance=.01cm]\n\\tikzstyle[sibling distance=12cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\scriptsize,set style={{every node}+=[fill=yellow]}]\n\\tikzstyle{level 1}=[sibling distance=40mm,font=\\footnotesize,set style={{every node}+=[fill=blue!15]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AX}}\n   child {node {AY}}\n   child {node {AZ}}\n }\n child {node {B}\n   child {node {BX}}\n   child {node {BY}}\n   child {node {BZ}}\n }\n child {node {C}\n   child {node {CX}}\n   child {node {CY}}\n   child {node {CZ}}\n };\n\\end{tikzpicture}}\n\\end{block}\\vspace*{0.1cm}\\fontsize{8}{8}\\sf\n\n\\hbox{$\\by_{t}= \\begin{pmatrix}\n    y_{\\text{Total},t}\\\\\n    y_{A,t}\\\\\n    y_{B,t}\\\\\n    y_{C,t}\\\\\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}=\n    {\\color{red}{\\begin{pmatrix}\n                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\\\\n                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\\\\n                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\\\\n             \\end{pmatrix}}}{\\color{blue}{\\begin{pmatrix}\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}}}$}\n\n\\begin{textblock}{3}(10.5,8)\\fontsize{14}{15}\\sf\\colorbox[gray]{.8}{$\\by_{t}=\\color{red}\\bS\\color{blue}\\bm{b}_{t}$}\\end{textblock}\n\n## Fast computation: hierarchical data\n\n\\begin{block}{}\\hspace*{.6cm}{\\centering\\small\n\\begin{tikzpicture}[level distance=1cm]\n\\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]\n\\tikzstyle[level distance=.01cm]\n\\tikzstyle[sibling distance=12cm]\n\\tikzstyle{level 2}=[sibling distance=10mm,font=\\scriptsize,set style={{every node}+=[fill=yellow]}]\n\\tikzstyle{level 1}=[sibling distance=40mm,font=\\footnotesize,set style={{every node}+=[fill=blue!15]}]\n\\node{Total}[edge from parent fork down]\n child {node {A}\n   child {node {AX}}\n   child {node {AY}}\n   child {node {AZ}}\n }\n child {node {B}\n   child {node {BX}}\n   child {node {BY}}\n   child {node {BZ}}\n }\n child {node {C}\n   child {node {CX}}\n   child {node {CY}}\n   child {node {CZ}}\n };\n\\end{tikzpicture}}\n\\end{block}\\vspace*{0.1cm}\\fontsize{8}{8}\\sf\n\n\\hbox{$\\by_{t}= \\begin{pmatrix}\n    y_{\\text{Total},t}\\\\\n    y_{A,t}\\\\\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{B,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{C,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}=\n    {\\color{red}{\\begin{pmatrix}\n      1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\\\\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      0 & 0 & 0 & 0 & 0 & 0\\\\\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      0 & 0 & 0 & 0 & 0 & 0\\\\\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      0 & 0 & 0 & 0 & 0 & 0\\\\\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      0 & 0 & 0 & 0 & 0 & 0\\\\\n      0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      0 & 0 & 0 \\\\\n      0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      0 & 0 & 0 \\\\\n      0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      0 & 0 & 0 \\\\\n      0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      0 & 0 & 0 \\\\\n      0 & 0 & 0 & 0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1}\\\\\n      0 & 0 & 0 & 0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0}\\\\\n      0 & 0 & 0 & 0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0}\\\\\n      0 & 0 & 0 & 0 & 0 & 0 &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{0} &\n      \\only<2>{\\textcolor[RGB]{128,0,128}}{1}\\\\\n   \\end{pmatrix}}}{\\color{blue}{\\begin{pmatrix}\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\\end{pmatrix}}}$}\n\n\\begin{textblock}{3}(10.5,8)\\fontsize{14}{15}\\sf\\colorbox[gray]{.8}{$\\by_{t}=\\color{red}\\bS\\color{blue}\\bm{b}_{t}$}\\end{textblock}\n\n## Fast computation: hierarchies\n\n\\fontsize{13.6}{15}\\sf\nThink of the hierarchy as a tree of trees:\n\\begin{center}\n\\begin{tikzpicture}[scale=0.8]\n%\\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]\n\\tikzstyle[level distance=.1cm]\n\\tikzstyle[sibling distance=7cm]\n%\\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]\n\\tikzstyle{level 1}=[sibling distance=33mm]\n\\node[ellipse,draw,inner sep=0.2pt,fill=red!15]{Total}[edge from parent fork down]\n child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_1$}\n }\n child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_2$}\n }\n child {node {\\dots}\n }\n child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_K$}\n };\n\\end{tikzpicture}\n\\end{center}\\pause\nThen the summing matrix contains $K$ smaller summing matrices:\n\n\\begin{multicols}{2}\n$\\displaystyle\n\\bS = \\left[\\begin{array}{cccc}\n{\\bf1}'_{n_1}&{\\bf1}'_{n_2}&\\cdots&{\\bf1}'_{n_K}\\\\\n\\bS_1&{{\\bf0}}&\\cdots&{\\bf0}\\\\\n{\\bf0}&\\bS_2&\\cdots&{\\bf0}\\\\\n\\vdots&\\vdots&\\ddots&\\vdots\\\\\n{\\bf0}&{\\bf0}&\\cdots&\\bS_K\n\\end{array}\\right]$\n\n\\columnbreak\n\nwhere ${\\bf1}_n$ is an $n$-vector of ones and tree $T_i$ has $n_i$ terminal nodes.\n\\end{multicols}\n\n## Fast computation: hierarchies\n\\vspace*{-0.4cm}\\fontsize{13}{15}\\sf\n$$\n\\!\\bS'\\!\\bLambda\\bS = \\left[\\begin{array}{cccc}\n\\bS_1'\\bLambda_1\\bS_1&{\\bf0}&\\cdots&{\\bf0}\\\\\n{\\bf0}&\\bS'_2\\bLambda_2\\bS_2&\\cdots&{\\bf0}\\\\\n\\vdots&\\vdots&\\ddots&\\vdots\\\\\n{\\bf0}&{\\bf0}&\\cdots&\\bS_K'\\bLambda_K\\bS_K\n\\end{array}\\right] + \\lambda_0\\,\\bJ_n\n$$\n\n* $\\lambda_0$ is the top left element of $\\bLambda$\n* $\\bLambda_k$ is a block of $\\bLambda$, corresponding to tree $T_k$\n* $\\bJ_n$ is a matrix of ones\n* $n=\\sum_k n_k$\n\n\\pause\n\\alert{Now apply the Sherman-Morrison formula \\dots}\n\n## Fast computation: hierarchies\n\\vspace*{-0.4cm}\\fontsize{13}{15}\\sf\n$$\\arraycolsep=0.1cm\n\\!(\\bS'\\!\\bLambda\\bS)^{-1} = \\left[\\begin{array}{cccc}\n(\\bS_1'\\bLambda_1\\bS_1)^{-1}&{\\bf0}&\\cdots&{\\bf0}\\\\\n{\\bf0}&(\\bS'_2\\bLambda_2\\bS_2)^{-1}&\\cdots&{\\bf0}\\\\\n\\vdots&\\vdots&\\ddots&\\vdots\\\\\n{\\bf0}&{\\bf0}&\\cdots&(\\bS_K'\\bLambda_K\\bS_K)^{-1}\n\\end{array}\\right] - c\\bS_0\n$$\n\n* $\\bS_0$ can be partitioned into $K^2$ blocks, with the $(k,\\ell)$ block\n(of dimension $n_k\\times n_\\ell$) being\n$(\\bS_k'\\bLambda_k\\bS_k)^{-1}\\bJ_{n_k,n_\\ell} (\\bS_\\ell'\\bLambda_\\ell\\bS_\\ell)^{-1}$\n* $\\bJ_{n_k,n_\\ell}$ is a $n_k\\times n_\\ell$ matrix of ones\n* $\\displaystyle c^{-1}=\\lambda_0^{-1}+\\sum_k {\\bf1}_{n_k}' (\\bS_k'\\bLambda_k\\bS_k)^{-1}{\\bf1}_{n_k}$\n* Each $\\bS_k'\\bLambda_k\\bS_k$ can be inverted similarly\n* $\\bS'\\!\\bLambda\\by$ can also be computed recursively\n\n\\only<2>{\\begin{textblock}{6}(9.8,6)\\fontsize{14}{15}\\sf\n\\begin{alertblock}{}\nThe recursive calculations can be done in such a way that we never store any of the large matrices involved.\n\\end{alertblock}\n\\end{textblock}}\n\\only<2>{\\placefig{15}{5.4}{width=1cm}{smiley}}\n\n## Fast computation: grouped data\n\n\\begin{block}{}\n\\begin{center}\\small\n\\tikzstyle{every node}=[inner sep=2pt]\\vspace*{-0.2cm}\n\\begin{tikzpicture}\n    \\matrix[ampersand replacement=\\&,column sep=0.2cm] {\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize,distance=1cm] {AX};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {AY};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {AZ};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {A}; \\\\[0.cm]\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {BX};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {BY};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {BZ};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {B}; \\\\[0.cm]\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {CX};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {CY};~ \\&\n        \\node[ellipse,draw,fill=yellow,font=\\scriptsize] {CZ};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {C}; \\\\[0.05cm]\n        \\node[ellipse,draw,fill=blue!15] {X};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {Y};~ \\&\n        \\node[ellipse,draw,fill=blue!15] {Z};~ \\&\n        \\node[ellipse,draw,fill=red!15] {Total}; \\\\\n};\n\\end{tikzpicture}\n\\end{center}\n\\end{block}\\vspace*{0.0cm}\\fontsize{8}{7}\\sf\n\n\\hbox{$\\by_{t}= \\begin{pmatrix}\n    y_t\\\\\n    y_{A,t}\\\\\n    y_{B,t}\\\\\n    y_{C,t}\\\\\n    y_{X,t}\\\\\n    y_{Y,t}\\\\\n    y_{Z,t}\\\\\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\n    \\end{pmatrix}=\n    \\color{red}\\begin{pmatrix}\n                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\\\\n                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\\\\n                1 & 0 & 0 & 1 & 0 & 0 & 1 & 0 & 0 \\\\\n                0 & 1 & 0 & 0 & 1 & 0 & 0 & 1 & 0 \\\\\n                0 & 0 & 1 & 0 & 0 & 1 & 0 & 0 & 1 \\\\\n                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\\\\n                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0  \\\\\n                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\\\\n                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\n             \\end{pmatrix}\\color{blue}\\begin{pmatrix}\n    y_{AX,t}\\\\\n    y_{AY,t}\\\\\n    y_{AZ,t}\\\\\n    y_{BX,t}\\\\\n    y_{BY,t}\\\\\n    y_{BZ,t}\\\\\n    y_{CX,t}\\\\\n    y_{CY,t}\\\\\n    y_{CZ,t}\n    \\end{pmatrix}$}\n\n\\begin{textblock}{3}(10.5,8)\\fontsize{12}{13}\\sf\\colorbox[gray]{.8}{$\\by_{t}=\\color{red}\\bS\\color{blue}\\bm{b}_{t}$}\\end{textblock}\n\n## Fast computation: grouped data\n\n$\\displaystyle \\bS=\\begin{bmatrix}\n\\bm{1}_m'\\otimes \\bm{1}_n'\\\\\n\\bm{1}_m'\\otimes \\bI_n\\\\\n\\bI_m\\otimes \\bm{1}_n'\\\\\n\\bI_m\\otimes \\bI_n\\\\\n\\end{bmatrix}$\\pause\n\\begin{block}{}\n\\centerline{$\\bS'\\!\\bLambda\\bS = \\lambda_{00}\\, \\bm{J}_{mn} + (\\bLambda_R\\otimes  \\bm{J}_{n}) + (\\bm{J}_{m}\\otimes \\bLambda_C) +  \\bLambda_U$}\n\\end{block}\n\\begin{itemize}\n\\item $\\bLambda_R$, $\\bLambda_C$ and $\\bLambda_U$ are diagonal matrices corresponding to rows, columns and unaggregated series;\n\\item $\\lambda_{00}$ corresponds to aggregate.\n\\end{itemize}\n\n\\begin{textblock}{7}(6,2.4)\n$m=$ number of rows\\\\\n$n=$ number of columns\n\\end{textblock}\n\n## Fast computation: grouped data\n\n\\begin{block}{}\n\\centerline{$\\displaystyle\n(\\bS\\bLambda\\bS)^{-1} = \\bm{A} - \\frac{\\bm{A}\\bm{1}_{mn}\\bm{1}_{mn}'\\bm{A}}\n  {1/\\lambda_{00} + \\bm{1}_{mn}'\\bm{A}\\bm{1}_{mn}}$}\n\\end{block}\\fontsize{12.5}{14}\\sf\\vspace*{-0.4cm}\n\n$\\bm{A} = \\bLambda_U^{-1} - \\bLambda_U^{-1}(\\bm{J}_m\\otimes \\bm{D})\\bLambda_U^{-1} - \\bm{E}\\bm{M}^{-1}\\bm{E}'.$\\newline\n$\\bm{D}$ is diagonal with elements \\rlap{$d_j=\\lambda_{0j}/(1+\\lambda_{0j}\\sum_i \\lambda_{ij}^{-1})$.}\\newline\n$\\bm{E}$ has $m\\times m$ blocks where $\\bm{e}_{ij}$ has $k$th element\n$$\n(\\bm{e}_{ij})_k = \\left \\{ \\begin{array}{lr}\n\\lambda_{i0}^{1/2} \\lambda_{ik}^{-1} - \\lambda_{i0}^{1/2} \\lambda_{ik}^{-2}d_k,& i=j,\\\\\n- \\lambda_{j0}^{1/2}\\lambda_{ik}^{-1}\\lambda_{jk}^{-1}d_k,& i\\neq j.\n\\end{array}\\right .\n$$\n$\\bm{M}$ is $m\\times m$ with $(i,j)$ element\n$$ (\\bm{M})_{ij} =\n\\left \\{ \\begin{array}{lr}\n1+\\lambda_{i0}\\sum_k \\lambda_{ik}^{-1} - \\lambda_{i0}\\sum_k \\lambda_{ik}^{-2}d_k,& i=j,\\\\\n- \\lambda_{i0}^{1/2}\\lambda_{j0}^{1/2}\\sum_k \\lambda_{ik}^{-1}\\lambda_{jk}^{-1}d_k,& i\\neq j.\n\\end{array}\\right .\n$$\n\n\\only<2>{\\begin{textblock}{4}(11.8,3.5)\\fontsize{12}{13}\\sf\n\\begin{alertblock}{}\nAgain, the calculations can be done in such a way that we never store any of the large matrices involved.\n\\end{alertblock}\n\\end{textblock}}\n\\only<2>{\\placefig{15}{6.7}{width=1cm}{smiley}}\n\n\\nocite{hierarchical, fasthts, mint}\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}