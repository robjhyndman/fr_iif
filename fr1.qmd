---
title: Forecast reconciliation
subtitle: 1. Hierarchical time series & forecast reconciliation
author: Rob J Hyndman
pdf-engine: pdflatex
fig-width: 9
fig-height: 4.5
format:
  beamer:
    theme: monash
    aspectratio: 169
    fontsize: 14pt
    section-titles: false
    knitr:
      opts_chunk:
        dev: "cairo_pdf"
include-in-header: header.tex
cite-method: biblatex
bibliography: hts.bib
biblio-title: References
keep-tex: true
execute:
  echo: false
  message: false
  warning: false
  cache: true
---

```{r}
#| label: setup
#| include: false
options(digits = 3, width = 88)
library(fpp3)
library(patchwork)
```

## Outline

\vspace*{0.4cm}\tableofcontents

# Hierarchical time series data

## Labour market participation
\fontsize{13}{14}\sf
\alert{Australia \& New Zealand Standard Classification of Occupations}
\begin{itemize}\tightlist
\item 8 major groups
\begin{itemize}\tightlist
\item 43 sub-major groups
\begin{itemize}\tightlist
\item 97 minor groups

\hspace*{1cm} 359 unit groups

\hspace*{2cm} 1023 occupations
\end{itemize}\end{itemize}\end{itemize}\pause

\begin{block}{Example: statistician}
\begin{itemize}
\item[2] Professionals
\begin{itemize}
\item[22] Business, Human Resource and Marketing Professionals
\begin{itemize}
\item[224] Information and Organisation Professionals

 \hspace*{1cm}2241 Actuaries, Mathematicians and Statisticians

\hspace*{2cm} 224113~~~Statistician
\end{itemize}
\end{itemize}
\end{itemize}
\end{block}

## PBS sales
\placefig{0}{1.4}{width=16cm, height=200cm}{pills}

## PBS sales
\alert{ATC drug classification}\fontsize{11}{11}\sffamily

\begin{tabular}{ll}
A &Alimentary tract and metabolism\\
B &Blood and blood forming organs\\
C &Cardiovascular system\\
D &Dermatologicals\\
G &Genito-urinary system and sex hormones\\
H &Systemic hormonal preparations, excluding sex hormones and insulins\\
J &Anti-infectives for systemic use\\
L &Antineoplastic and immunomodulating agents\\
M &Musculo-skeletal system\\
N &Nervous system\\
P &Antiparasitic products, insecticides and repellents\\
R &Respiratory system\\
S &Sensory organs\\
V &Various
\end{tabular}

## PBS sales
\alert{ATC drug classification}\fontsize{11}{11}\sffamily

\begin{minipage}{9.6cm}
\begin{tikzpicture}[level distance=13mm]
\tikzstyle{every node}=[ellipse,font=\small,draw,fill=red!15,inner sep=0.1cm]
\tikzstyle[level font=\small,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 1}=[font=\small,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 2}=[font=\small,set style={{every node}+=[fill=yellow]}]
\node[label=right:\hspace*{-0.cm}Alimentary tract and metabolism,label=left:\textbf{14 classes}\hspace*{0.3cm}]{A}[edge from parent fork down]
   child {node[label=right:\hspace*{-0.0cm}Drugs used in diabetes,label=left:\textbf{84 classes}]{A10}
     child {node[label=right:\hspace*{-0.35cm}Blood glucose lowering drugs]{A10B}
       child {node[label=right:\hspace*{0.1cm}Biguanides]{A10BA}
         child {node[label=right:\hspace*{-0.15cm}Metformin]{A10BA02}
 }}}};
 \end{tikzpicture}
\end{minipage}

## Spectacle sales

\placefig{7}{5}{width=8.7cm}{spectacles}
\begin{textblock}{12}(0.3,1.5)
\begin{itemize}\tightlist
    \item Monthly UK sales data from 2000 -- 2014
    \item Provided by a large spectacle \rlap{manufacturer}
    \item Split by brand (26), gender (3), price range (6), materials (4), and stores (600)
    \item About 1 million bottom-level series
\end{itemize}
\end{textblock}

## Australian tourism regions

```{r}
#| label: ausmap
#| fig-height: 3
library(sf)
# Use Okabe-Ito color-blind friendly color palette
state_colors <- c(
  `New South Wales` = "#56b4e9",
  `Victoria` = "#0072b2",
  `Queensland` = "#009e73",
  `South Australia` = "#f0e442",
  `Northern Territory` = "#d55e00",
  `Western Australia` = "#e69f00",
  `Tasmania` = "#cc79a7",
  `Australian Capital Territory` = "#cccccc"
)
read_sf("tourism/Tourism_Regions_2020.shp") |>
  rename(State = "STE_NAME16") |>
  ggplot() +
  geom_sf(aes(fill = State), alpha = 0.8) +
  theme_void() +
  scale_fill_manual(values = state_colors)
```

\only<2>{\begin{textblock}{6.5}(9.1,1.4)
\begin{block}{}%\fontsize{12}{13}\sf
  \begin{itemize}\itemsep=0cm\parskip=0cm
    \item Monthly data on visitor night from 1998 -- 2017
    \item From \textit{National Visitor Survey}, annual interviews of 120,000 Australians aged 15+.
    \item Geographical hierarchy split by
    \begin{itemize}
    \item 7 states
    \item 27 zones
    \item 75 regions
    \end{itemize}
  \end{itemize}
\end{block}
\end{textblock}}

```{r}
#| label: tourism
# Read csv file of monthly data
OvernightTrips_Region <- readr::read_csv("tourism/OvernightTrips_2017.csv")[, -(1:3)] |>
  # Replace outlier from Adelaide Hills
  mutate(
    `Adelaide Hills` = case_when(
      `Adelaide Hills` > 80 ~ 10,
      TRUE ~ `Adelaide Hills`
    )
  )
# Convert to tsibble
tourism <- hts::hts(
  ts(OvernightTrips_Region, start = 1998, frequency = 12),
  list(7, c(6, 5, 4, 4, 3, 3, 2), c(2, 2, 1, 4, 4, 1, 3, 1, 3, 6, 7, 3, 4, 3, 2, 3, 3, 4, 2, 3, 1, 1, 1, 2, 2, 3, 4))
) |>
  as_tsibble() |>
  rename(
    state = "Level 1",
    zone = "Level 2",
    region = "Level 3",
    month = index,
    visitors = value
  ) |>
  mutate(
    state = recode(state,
      A = "NSW",
      B = "VIC",
      C = "QLD",
      D = "SA",
      E = "WA",
      F = "TAS",
      G = "NT"
    ),
    zone = recode(zone,
      AA = "Metro NSW",
      AB = "North Coast NSW",
      AC = "South Coast NSW",
      AD = "South NSW",
      AE = "North NSW",
      AF = "ACT",
      BA = "Metro VIC",
      BB = "West Coast VIC",
      BC = "East Coast VIC",
      BC = "North East VIC",
      BD = "North West VIC",
      CA = "Metro QLD",
      CB = "Central Coast QLD",
      CC = "North Coast QLD",
      CD = "Inland QLD",
      DA = "Metro SA",
      DB = "South Coast SA",
      DC = "Inland SA",
      DD = "West Coast SA",
      EA = "West Coast WA",
      EB = "North WA",
      EC = "South WA",
      FA = "South TAS",
      FB = "North East TAS",
      FC = "North West TAS",
      GA = "North Coast NT",
      GB = "Central NT"
    )
  ) |>
  select(month, everything())
```

## Australian tourism data

```{r}
#| label: tourism_plots
#| fig-width: 12
#| fig-height: 5

p1 <- tourism |>
  summarise(visitors = sum(visitors)) |>
  autoplot(visitors) +
  ylab("Overnight trips") + xlab("Month") +
  scale_y_log10() +
  ggtitle("Total domestic travel: Australia")
p2 <- tourism |>
  group_by(state) |>
  summarise(visitors = sum(visitors)) |>
  autoplot(visitors) +
  ylab("Overnight trips") + xlab("Month") +
  scale_y_log10() +
  ggtitle("Total domestic travel: by state") +
  scale_color_manual(
    values =
      c(
        NSW = "#56b4e9",
        VIC = "#0072b2",
        QLD = "#009e73",
        SA = "#f0e442",
        NT = "#d55e00",
        WA = "#e69f00",
        TAS = "#cc79a7",
        ACT = "#cccccc"
      )
  )
p3 <- tourism |>
  filter(state == "NSW") |>
  group_by(zone) |>
  summarise(visitors = sum(visitors)) |>
  mutate(zone = paste0("NSW/", zone)) |>
  autoplot(visitors) +
  ylab("Overnight trips") + xlab("Month") +
  scale_y_log10() +
  ggtitle("Total domestic travel: NSW by zone") +
  guides(colour = guide_legend(title = "state/zone"))
p4 <- tourism |>
  filter(zone == "South NSW") |>
  autoplot(visitors) +
  ylab("Overnight trips") + xlab("Month") +
  scale_y_log10() +
  ggtitle("Total domestic travel: South NSW by region")
aligned_plots <- align_patches(p1, p2, p3, p4)
for (i in seq_along(aligned_plots)) {
  cairo_pdf(paste0("./figs/tourism", i, ".pdf"), width = 12 * .8, height = 5 * .8)
  print(aligned_plots[[i]])
  crop::dev.off.crop()
}
```

\only<1>{\placefig{0.3}{1.7}{width=15.5cm}{tourism1}}
\only<2>{\placefig{0.3}{1.7}{width=15.5cm}{tourism2}}
\only<3>{\placefig{0.3}{1.7}{width=15.5cm}{tourism3}}
\only<4>{\placefig{0.3}{1.7}{width=15.5cm}{tourism4}}

## Hierarchical time series
\vspace*{-0.2cm}

A \alert{\textbf{hierarchical time series}} is a collection of several time series that are linked together in a hierarchical structure.

\vspace*{-0.5cm}
\begin{center}
\begin{minipage}{9.6cm}
\begin{block}{}
\begin{tikzpicture}
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]
\tikzstyle[level distance=.1cm]
\tikzstyle[sibling distance=7cm]
\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AA}}
   child {node {AB}}
   child {node {AC}}
 }
 child {node {B}
   child {node {BA}}
   child {node {BB}}
   child {node {BC}}
 }
 child {node {C}
   child {node {CA}}
   child {node {CB}}
   child {node {CC}}
 };
\end{tikzpicture}
\end{block}
\end{minipage}
\end{center}

\pause\alert{Examples}\vspace*{-0.4cm}

 * Tourism by state and region
 * Retail sales by product groups, sub groups, and SKUs

## Grouped time series

A \alert{\textbf{grouped time series}} is a collection of time series that can be grouped together in a number of non-hierarchical ways.

\vspace*{-0.2cm}\begin{center}
\begin{minipage}{9.2cm}
\begin{block}{}
\begin{tikzpicture}[level distance=1.5cm]
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]
\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
 };
\end{tikzpicture}\hspace*{1cm}
\begin{tikzpicture}[level distance=1.5cm]
\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,outer sep=0pt, fill=red!15]
\tikzstyle{level 1}=[sibling distance=23mm,set style={{every node}+=[fill=blue!15]},level distance=1cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=yellow]}, level distance=0.9cm]
\node{Total}[edge from parent fork down]
 child {node {X}
   child {node {AX}}
   child {node {BX}}
 }
 child {node {Y}
   child {node {AY}}
   child {node {BY}}
 };
\end{tikzpicture}
\end{block}
\end{minipage}
\end{center}

\pause\alert{Examples}\vspace*{-0.4cm}

 * Tourism by state and purpose of travel
 * Retail sales by product groups/sub groups, and by countries/regions

## Hierarchical and grouped time series

\begin{textblock}{8.5}(0.2,1.5)
Every collection of time series with linear constraints can be written as
\centerline{\colorbox[RGB]{210,210,210}{$\bY_{t}=\color{blue}\bS\color{red}\bm{b}_{t}$}}
\vspace*{-0.9cm}\begin{itemize}\parskip=0cm\itemsep=0cm
\item $\by_t=$ vector of all series at time $t$
\item $ y_{t}= $ aggregate of all series at time
$t$.
\item $ y_{X,t}= $ value of series $X$ at time $t$.
\item $\color{red}{\bm{b}_t}=$ vector of most disaggregated series at time $t$
\item $\color{blue}{\bS}=$ ``summing matrix'' containing the linear constraints.
\end{itemize}
\end{textblock}

\begin{textblock}{5.7}(11.4,0.1)
\begin{minipage}{4cm}
\begin{block}{}\centering
\begin{tikzpicture}
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.3cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 1}=[sibling distance=10mm,font=\small,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
 }
 child {node {B}
 }
 child {node {C}
 };
\end{tikzpicture}
\end{block}
\end{minipage}
\end{textblock}

\begin{textblock}{5.7}(9.4,2.8)\fontsize{14}{15}\sf
\begin{align*}
\bY_{t}&= \begin{pmatrix}
  y_{t}\\
  y_{A,t}\\
  y_{B,t}\\
  y_{C,t}
  \end{pmatrix}  \\
  &= {\color{blue}\underbrace{\begin{pmatrix}
                1 & 1 & 1 \\
                1 & 0 & 0 \\
                0 & 1 & 0\\
                0 & 0 & 1
                \end{pmatrix}}_{\bS}}
     {\color{red}\underbrace{\begin{pmatrix}
       y_{A,t}\\y_{B,t}\\y_{C,t}
       \end{pmatrix}}_{\bm{b}_{t}}}
\end{align*}
\end{textblock}

\vspace*{10cm}

## Hierarchical time series

\begin{block}{}\hspace*{.6cm}{\centering\small
\begin{tikzpicture}[level distance=1cm]
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.01cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\scriptsize,set style={{every node}+=[fill=yellow]}]
\tikzstyle{level 1}=[sibling distance=40mm,font=\footnotesize,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
   child {node {AZ}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
   child {node {BZ}}
 }
 child {node {C}
   child {node {CX}}
   child {node {CY}}
   child {node {CZ}}
 };
\end{tikzpicture}}
\end{block}\vspace*{0.1cm}\pause\fontsize{8}{8}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{C,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}=
    {\color{red}{\begin{pmatrix}
                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\
                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
             \end{pmatrix}}}{\color{blue}{\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}}}$}

    \vspace*{10cm}

\only<3>{\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}}

## Grouped data

\begin{block}{}
\begin{center}\small
\tikzstyle{every node}=[inner sep=2pt]
\begin{tikzpicture}
    \matrix[ampersand replacement=\&,column sep=0.3cm] {
        \node[ellipse,draw,fill=yellow,font=\scriptsize,distance=1cm] {AX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {AY};~ \&
        \node[ellipse,draw,fill=blue!15] {A}; \\[0.3cm]
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BY};~ \&
        \node[ellipse,draw,fill=blue!15] {B}; \\[0.3cm]
        \node[ellipse,draw,fill=blue!15] {X};~ \&
        \node[ellipse,draw,fill=blue!15] {Y};~ \&
        \node[ellipse,draw,fill=red!15] {Total}; \\
};
\end{tikzpicture}
\end{center}
\end{block}\pause\fontsize{10}{11}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{X,t}\\
    y_{Y,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{BX,t}\\
    y_{BY,t}
    \end{pmatrix}=
    \color{red}\begin{pmatrix}
                1 & 1 & 1 & 1 \\
                1 & 1 & 0 & 0 \\
                0 & 0 & 1 & 1 \\
                1 & 0 & 1 & 0 \\
                0 & 1 & 0 & 1 \\
                1 & 0 & 0 & 0 \\
                0 & 1 & 0 & 0 \\
                0 & 0 & 1 & 0 \\
                0 & 0 & 0 & 1
             \end{pmatrix}
    \color{blue}\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{BX,t}\\
    y_{BY,t}
    \end{pmatrix}$}

\vspace*{-1cm}

\only<3>{\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}}

\vspace*{10cm}

## The hierarchical forecasting problem

* We want forecasts at all levels of aggregation.
* If we model and forecast each series independently, the forecasts will almost certainly not add up.
* We need to impose constraints on the forecasts to ensure they are "coherent".
* We need to do this in a way that is computationally efficient.

# Hierarchical forecasting using single-level approaches

## Hierarchical forecasting 20 years ago

```{r}
#| label: pyramid
pdf("figs/pyramid.pdf", width = 15 / 2.54, height = 15 / 2.54)
plot(c(-1, 1), c(0.1, 1), type = "n", bty = "n", xlab = "", ylab = "", xaxt = "n", yaxt = "n")
polygon(c(-1, 1, 0, -1), c(0, 0, 1, 0), col = rgb(230, 172, 0, max = 255), border = FALSE)
abline(a = 0.666, b = 0, col = "white", lwd = 5)
abline(a = 0.333, b = 0, col = "white", lwd = 5)
text(0, 0.8, "Top-down")
text(0, 0.5, "Middle-out")
text(0, 0.18, "Bottom-up")
arrows(0, 0.22, 0, 0.3, length = 0.1, lwd = 3, col = "black")
arrows(0, 0.77, 0, 0.69, length = 0.1, lwd = 3, col = "black")
arrows(0, 0.55, 0, 0.63, length = 0.1, lwd = 3, col = "black")
arrows(0, 0.45, 0, 0.37, length = 0.1, lwd = 3, col = "black")
crop::dev.off.crop()
system("pdfcrop figs/pyramid.pdf figs/pyramid.pdf")
```

\placefig{0.3}{1.5}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism1}
\placefig{0.3}{4.}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism2}
\placefig{0.3}{6.5}{height=2.5cm, width=10cm, trim=0 0 180 0, clip=TRUE}{tourism4}
\placefig{6}{1.4}{width=7.8cm, height=7.8cm}{pyramid}

## Top-down forecasting

\begin{textblock}{7}(0.4,1.4)
\alert{Advantages}
\begin{itemize}\tightlist
    \item Works well in presence of low counts.
    \item Single forecasting model easy to build
    \item Provides reliable forecasts for aggregate levels.
\end{itemize}
\end{textblock}
\begin{textblock}{7}(8,1.4)
\alert{Disadvantages}
\begin{itemize}\tightlist
    \item Loss of information, especially individual series dynamics.
    \item Distribution of forecasts to lower levels can be difficult
    \item No prediction intervals
\end{itemize}
\end{textblock}

## Bottom-up forecasting

\begin{textblock}{7}(0.4,1.4)
\alert{Advantages}
\begin{itemize}\tightlist
    \item No loss of information.
    \item Better captures dynamics of
    individual series.
\end{itemize}
\end{textblock}
\begin{textblock}{7}(8,1.4)
\alert{Disadvantages}
\begin{itemize}\tightlist
    \item Large number of series to be forecast.
    \item Constructing forecasting models is harder because of noisy
    data at bottom level.
    \item No prediction intervals
\end{itemize}
\end{textblock}

## Forecasting notation

Let $\hat{\bm{y}}_{T+h|T}$ be vector of initial $h$-step forecasts, made at time $T$, stacked in same order as $\by_t$. (In general, they will not "add up".)\pause

\begin{block}{}
Coherent linear forecasts are of the form:

\centerline{$\tilde{\bm{y}}_{T+h|T}=\bS\bm{G}\hat{\bm{y}}_{T+h|T}$}

for some matrix $\bm{G}$.
\end{block}\pause

* $\bm{G}$ extracts and combines base forecasts $\hat{\bm{y}}_{T+h|T}$ to get bottom-level forecasts.
* $\bS$ adds them up

## Bottom-up forecasting

\vspace*{0.2cm}\begin{block}{}
\centerline{$\tilde{\bm{y}}_{T+h|T}=\bS\bm{G}\hat{\bm{y}}_{T+h|T}$}
\end{block}

Bottom-up forecasts are obtained using
$$
\bm{G} = \left[\bm{0}\mid \bm{I}\right],
$$
where $\bm{0}$ is null matrix and $\bm{I}$ is identity matrix.
\begin{itemize}\tightlist
\item $\bm{G}$ matrix extracts only bottom-level forecasts from $\hat{\bm{y}}_{T+h|T}$
\item $\bS$ adds them up to give the bottom-up forecasts.
\end{itemize}
\vspace*{10cm}

## Top-down forecasting

\vspace*{0.2cm}\begin{block}{}
\centerline{$\tilde{\bm{y}}_{T+h|T}=\bS\bm{G}\hat{\bm{y}}_{T+h|T}$}
\end{block}

Top-down forecasts are obtained using
$$
\bm{G}= \left[\bm{p}\mid\bm{0}\right]
$$
where $\bm{p}=[p_{1},p_{2},\dots,p_{n_b}]'$ and $\displaystyle\sum_{k=1}^{n_b} p_k = 1$.
\begin{itemize}\tightlist
\item $\bm{G}$ distributes forecasts of aggregate to lowest level series.
\item Different methods of top-down forecasting lead to different proportionality vectors $\bm{p}$.
\end{itemize}
\vspace*{10cm}

## Properties of single-level methods

\vspace*{0.2cm}\begin{block}{}
\centerline{$\tilde{\bm{y}}_{t+h|t}=\bS\bG\hat{\bm{y}}_{t+h|t}$}
\end{block}

\begin{block}{Mean}\vspace*{-0.8cm}
\begin{align*}
\E[\tilde{\by}_{T+h|T} \mid \by_1,\dots,\by_T]
 & = \bm{S}\bm{G}\E[\hat{\by}_{T+h|T} \mid \by_1,\dots,\by_T] \\
 & = \bm{S}\E[\bm{b}_{T+h|T} \mid \by_1,\dots,\by_T]\\[-1.2cm]
\end{align*}
provided $\bS\bG\bS = \bS$
and $\E[\hat{\by}_{T+h|T} \mid \by_1,\dots,\by_T] = \bm{S}\E[\bm{b}_{T+h|T} \mid \by_1,\dots,\by_T]$.
i.e., forecasts $\tilde{\bm{y}}_{T+h|T}$ are unbiased iff base forecasts $\hat{\bm{y}}_{T+h|T}$ are unbiased and $\bS\bG\bS=\bS$.
\end{block}\pause

* $\bS\bG\bS = \bS$ for bottom-up method
* $\bS\bG\bS \ne \bS$ for any top-down or middle-out method.

## Properties of single-level methods

\vspace*{0.2cm}\begin{block}{}
\centerline{$\tilde{\bm{y}}_{t+h|t}=\bS\bG\hat{\bm{y}}_{t+h|t}$}
\end{block}

\begin{block}{Variance}\vspace*{-0.8cm}
\begin{align*}
\bm{V}_h &= \var[\by_{T+h} - \tilde{\by}_{T+h|T}  \mid \by_1,\dots,\by_T] \\
& = \bS\bG\bm{W}_{h}\bG'\bS'\\[-1.2cm]
\end{align*}
where $\bm{W}_h = \var[\by_{T+h} - \hat{\by}_{T+h|T} \mid \by_1,\dots,\by_T]$
\end{block}\pause

* $\bm{W}_h$ is hard to estimate for $h>1$.
* This suggests we should choose $\bm{G}$ to minimise $\bm{V}_h$.

\vspace*{10cm}

# Linear forecast reconciliation

## Early history of forecast reconciliation

\begin{textblock}{15.4}(0.3,1.5)
\begin{block}{History}\fontsize{12}{13}\sf
\begin{multicols}{2}
\begin{description}[0000:]\parskip=0cm\itemsep=0.05cm
\item[2001:] Idea to use all available series to forecast Australia's labour market by occupation.
\item[2004:] PhD student Roman Ahmed begins, co-supervised with George Athanasopoulos.
\item[2006:] Presentation at ISF, Santander.
\item[2007:] Pre-print of ``Optimal combination forecasts for hierarchical time series''.
\item[2009:] Application to Australian tourism published in IJF.
\item[2010:] First version of hts package on CRAN.
\item[2011:] ``Optimal combination forecasts for hierarchical time series'' appears in CSDA.
\item[2019:] ``Optimal forecast reconciliation for hierarchical and grouped time series through trace minimization''' appears in JASA.
\end{description}
\end{multicols}
\end{block}
\end{textblock}

## Forecast reconciliation research

```{r}
#| label: gs_searches
#| fig-width: 8
#| fig-height: 4
# Time series of Google Scholar papers on "hierarchical forecasting" and "forecast reconciliation"
# example: https://scholar.google.com/scholar?q=%22forecast+reconciliation%22&hl=en&as_sdt=1%2C5&as_ylo=2020&as_yhi=2020
# Google scholar won't let this be automated as repeated calls using rvest generates a 429 error.
gspapers <- bind_rows(
  tibble(
    year = 1980:2022,
    count = c(
      1, 0, 0, 1, 3, 2, 0, 1, 2, 2, # 1980s
      0, 2, 2, 1, 0, 1, 2, 1, 1, 1, # 1990s
      1, 5, 4, 3, 5, 8, 14, 14, 39, 38, # 2000s
      19, 17, 24, 36, 43, 38, 44, 71, 72, 112, # 2010s
      121,147,192
    ),
    search = "Hierarchical forecasting"
  ),
  tibble(
    year = 1980:2022,
    count = c(
      0, 0, 0, 0, 0, 0, 1, 0, 1, 0, # 1980s
      0, 0, 0, 0, 2, 2, 1, 1, 3, 1, # 1990s
      2, 3, 1, 3, 2, 3, 2, 0, 3, 1, # 2000s
      4, 4, 4, 6, 4, 6, 11, 15, 24, 35, # 2010s
      55,93,46
    ),
    search = "Forecast reconciliation"
  )
)
gspapers |>
  mutate(
    search = factor(search, levels = c(
      "Hierarchical forecasting",
      "Forecast reconciliation"
    ))
  ) |>
  as_tsibble(index = year, key = search) |>
  filter(year >= 1990) |>
  autoplot(count, lwd = 1) +
  ggtitle("Google Scholar items by year") +
  labs(x = "Year") +
  guides(colour = guide_legend(title = "Search term")) +
  scale_color_manual(values = c(
    `Forecast reconciliation` = "#d95f02",
    `Hierarchical forecasting` = "#7570b3"
  ))
```

## Forecast reconciliation research

```{r}
#| label: isf_searches
#| fig-width: 8
#| fig-height: 4
library(pdftools)
library(stringr)
isf <- tibble(
  year = 1990:2022,
  hierarch = NA,
  reconcil = NA
)

for (i in seq(NROW(isf))) {
  file <- paste0("ISF_programs/ISF", isf$year[i], ".pdf")
  tmp <- pdf_text(file)
  # Combine all strings, remove spaces, convert to lower case
  one_string <- paste0(tmp, collapse = "") |>
    str_remove_all("\\s") |>
    tolower()
  isf$hierarch[i] <- length(str_extract_all(one_string, "hierarch")[[1]])
  isf$reconcil[i] <- length(str_extract_all(one_string, "reconcil")[[1]])
}

isf |>
  pivot_longer(-year, names_to = "search", values_to = "count") |>
  as_tsibble(index = year, key = search) |>
  autoplot(count, lwd = 1) +
  ggtitle("Occurrence of term in ISF program") +
  guides(colour = guide_legend(title = "Search term")) +
  scale_color_manual(values = c(
    `reconcil` = "#d95f02",
    `hierarch` = "#7570b3"
  )) +
  labs(x = "Year")
```

## Linear forecast reconciliation

\vspace*{0.2cm}\begin{block}{}
\centerline{$\tilde{\bm{y}}_{T+h|T}=\bS\bG\hat{\bm{y}}_{T+h|T}$}
\end{block}\vspace*{-0.4cm}
\begin{itemize}\tightlist
\item $\bG$ combines base forecasts $\hat{\by}_{T+h|T}$ to get bottom-level forecasts.
\item $\bS$ creates linear combinations.
\item Bottom-up and top-down can be seen as special cases.
\item $\bS\bG$ is a projection matrix iff $\bS\bG\bS'=\bS$.
\item Reconciled forecasts are unbiased iff base forecasts are unbiased and $\bS\bG$ is a projection.
\item $\bm{V}_h = \var[\by_{T+h} - \tilde{\by}_{T+h|T}  \mid \by_1,\dots,\by_T] = \bS\bG\bm{W}_{h}\bG'\bS'$
\item How to choose $\bm{G}$ to create optimal forecasts?
\end{itemize}

## Minimum trace reconciliation

\vspace*{0.2cm}\begin{alertblock}{Minimum trace (MinT) reconciliation}
If $\bS\bG$ is a projection, then the trace of $\bm{V}_h$ is minimized when
\centerline{$\bG = (\bS'\bm{W}_h^{-1}\bS)^{-1}\bS'\bm{W}_h^{-1}$}
\end{alertblock}
\begin{block}{}
\centerline{$\displaystyle\textcolor{red}{\tilde{\by}_{T+h|T}}
=\bS(\bS'\bm{W}_h^{-1}\bS)^{-1}\bS'\bm{W}_h^{-1}\textcolor{blue}{\hat{\by}_{T+h|T}}$}
\end{block}
\centerline{\hspace*{1cm}\textcolor{red}{Reconciled forecasts}\hfill\textcolor{blue}{Base forecasts}\hspace*{2cm}}

* Trace of $\bm{V}_h$ is sum of forecast variances.
* MinT solution is $L_2$ optimal amongst linear unbiased forecasts.
* How to estimate $\bm{W}_h = \var[\by_{T+h} - \hat{\by}_{T+h|T} \mid \by_1,\dots,\by_T]$?
* Is $\bm{W}_h \approx k_h \bm{W}_1$ a reasonable approximation?

## Linear projections

\begin{textblock}{5}(6,0)
\begin{block}{}
\centerline{$\tilde{\by}_{T+h|T}=\bS\bG\hat{\by}_{T+h|T}$}
\end{block}
\end{textblock}

\begin{textblock}{9.4}(.5,1.2)
\begin{alertblock}{Reconciliation method \hspace*{0.5cm} $\bG$}
\begin{tabular}{ll}
  OLS             & $(\bS'\bS)^{-1}\bS'$ \\
  WLS(var)        & $(\bS'\bm{\Lambda}_v\bS)^{-1}\bS'\bm{\Lambda}_v$ \\
  WLS(struct)     & $(\bS'\bm{\Lambda}_s\bS)^{-1}\bS'\bm{\Lambda}_s$ \\
  MinT(sample)    & $(\bS'\hat{\bm{W}}_{\text{sam}}^{-1}\bS)^{-1}\bS' \hat{\bm{W}}_{\text{sam}}^{-1}$  \\
  MinT(shrink)\hspace*{2cm}    & $(\bS'\hat{\bm{W}}_{\text{shr}}^{-1}\bS)^{-1}\bS' \hat{\bm{W}}_{\text{shr}}^{-1}$  \\
\end{tabular}
\end{alertblock}
\end{textblock}
\begin{textblock}{15}(.2,5.7)\fontsize{13}{15}\sf
\begin{itemize}\parskip=0cm
\item $\bm{\Lambda}_v = \text{diag}(\bm{W}_1)^{-1}$
\item $\hat{\bm{W}}_{\text{sam}}$ is sample estimate of the residual covariance matrix
\item $\hat{\bm{W}}_{\text{shr}}$ is shrinkage estimator $\tau \text{diag}(\hat{\bm{W}}_{\text{sam}})+(1-\tau)\hat{\bm{W}}_{\text{sam}}$\\ where $\tau$ selected optimally.
\item Still need a good estimate of $\bm{W}_h$ for forecast variance.
\end{itemize}
\end{textblock}
\begin{textblock}{14}(4.5,5.7)\fontsize{13}{15}\sf
\begin{itemize}\tightlist
\item $\bm{\Lambda}_s = \text{diag}(\bS\bm{1})^{-1}$
\end{itemize}
\end{textblock}
\begin{textblock}{5}(10.3,3.35)
\begin{block}{}
These approximate MinT by assuming $\bm{W}_h = k_h \bm{W}_1$.
\end{block}
\end{textblock}

## OLS is not as bad as you might think

* If all base forecasts come from the same model, then forecast errors are coherent.
* So $\hat{\bm{y}}_{T+h|T} = \bm{S}\hat{\bm{b}}_{T+h|T} + \bm{S}\hat{\bm{\varepsilon}}_{T+h}$ and
$$
  \bm{W}_h = \var(\bm{y}_{T+h} - \hat{\bm{y}}_{T+h|T}) = \bm{S}\bm{\Sigma}_h\bm{S}'
$$
where $\bm{\Sigma}_h = \var(\hat{\bm{\varepsilon}}_{T+h})$. So
\begin{align*}
\bG &= \big[\bS'\bm{W}_h^{-1}\bS\big]^{-1}\bS'\bm{W}_h^{-1} \\
    &= \big[\bS'(\bm{S}\bm{\Sigma}_h\bm{S}')^{-1}\bS\big]^{-1}\bS'(\bm{S}\bm{\Sigma}_h\bm{S}')^{-1} \\
    &= (\bm{S}'\bm{S})^{-1}\bS'\\[-0.9cm]
\end{align*}
\rightline{(Proof: Hyndman et al, \emph{CSDA} 2011)\hspace*{1cm}}

# Example: Australian tourism

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r tourismdata, echo=TRUE}
tourism
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r tourismagg, echo=TRUE}
tourism_agg <- tourism |>
  aggregate_key(state / zone / region, visitors = sum(visitors))
```

```{r tourismagg2, echo=FALSE}
tourism_agg
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r tourismmodels, echo=TRUE}
fit <- tourism_agg |>
  filter(year(month) <= 2015) |>
  model(ets = ETS(visitors))
```

```{r tourismmodels1, echo=FALSE}
fit
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism, echo=TRUE}
fc <- fit |>
  reconcile(
    ols = min_trace(ets, method = "ols"),
    wlsv = min_trace(ets, method = "wls_var"),
    wlss = min_trace(ets, method = "wls_struct"),
    # mint_c = min_trace(ets, method="mint_cov"),
    mint_s = min_trace(ets, method = "mint_shrink"),
  ) |>
  forecast(h = "2 years")
```

```{r fctourism1, echo=FALSE}
fc
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism2, dependson='fctourism', echo=TRUE, fig.width=12, fig.height=4.5}
fc |>
  filter(is_aggregated(state)) |>
  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism3, dependson='fctourism', echo=TRUE, fig.width=12, fig.height=4.5}
fc |>
  filter(state == "NSW" & is_aggregated(zone)) |>
  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism4, dependson='fctourism', echo=TRUE, fig.width=12, fig.height=4.5}
fc |>
  filter(region == "Melbourne") |>
  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism5, dependson='fctourism', echo=TRUE, fig.width=12, fig.height=4.5}
fc |>
  filter(region == "Snowy Mountains") |>
  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fctourism6, dependson='fctourism', echo=TRUE, fig.width=12, fig.height=4.5}
fc |>
  filter(region == "Barossa") |>
  autoplot(filter(tourism_agg, year(month) > 2012), level = NULL)
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fcaccuracy, dependson='fctourismcomb', echo=TRUE}
fc |>
  accuracy(
    data = tourism_agg,
    measures = list(rmsse = RMSSE)
  )
```

## Example: Australian tourism
\fontsize{10}{11}\sf

```{r fcaccuracy2, dependson='fctourismcomb', echo=TRUE}
fc |>
  accuracy(tourism_agg,
    measures = list(mase = MASE, rmsse = RMSSE)
  ) |>
  group_by(.model) |>
  summarise(mase = mean(mase), rmsse = sqrt(mean(rmsse^2))) |>
  arrange(rmsse)
```

\only<2>{\begin{textblock}{7}(7,5)
\begin{block}{}\fontsize{13}{14}\sf
\begin{itemize}\tightlist
\item Overall, every reconciliation method is better than the base ETS forecasts.
\end{itemize}
\end{block}
\end{textblock}}

## Example: Australian tourism
\fontsize{8}{7}\sf

```{r fcaccuracy3, dependson='fctourismcomb', echo=FALSE}
fc |>
  accuracy(tourism_agg,
    measures = list(mase = MASE, rmsse = RMSSE)
  ) |>
  mutate(
    level = case_when(
      is_aggregated(state) ~ "National",
      is_aggregated(zone) ~ "State",
      is_aggregated(region) ~ "Zone",
      TRUE ~ "Region"
    ),
    level = factor(level, levels = c("National", "State", "Zone", "Region"))
  ) |>
  group_by(.model, level) |>
  summarise(mase = mean(mase), rmsse = sqrt(mean(rmsse^2))) |>
  arrange(level, rmsse)
```

\only<2>{\begin{textblock}{7}(7,5)
\begin{block}{}\fontsize{13}{14}\sf
\begin{itemize}\tightlist
\item OLS is best for all levels except national.
\item Improvements due to reconciliation are greater at lower levels.
\end{itemize}
\end{block}
\end{textblock}}

# Fast computational tricks

## Fast computation: hierarchical data

\begin{block}{}\hspace*{.6cm}{\centering\small
\begin{tikzpicture}[level distance=1cm]
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.01cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\scriptsize,set style={{every node}+=[fill=yellow]}]
\tikzstyle{level 1}=[sibling distance=40mm,font=\footnotesize,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
   child {node {AZ}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
   child {node {BZ}}
 }
 child {node {C}
   child {node {CX}}
   child {node {CY}}
   child {node {CZ}}
 };
\end{tikzpicture}}
\end{block}\vspace*{0.1cm}\fontsize{8}{8}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{C,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}=
    {\color{red}{\begin{pmatrix}
                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\
                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1\\
             \end{pmatrix}}}{\color{blue}{\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}}}$}

\vspace*{10cm}

\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}

## Fast computation: hierarchical data

\begin{block}{}\hspace*{.6cm}{\centering\small
\begin{tikzpicture}[level distance=1cm]
\tikzstyle{every node}=[ellipse,draw,fill=red!15,inner sep=2pt]
\tikzstyle[level distance=.01cm]
\tikzstyle[sibling distance=12cm]
\tikzstyle{level 2}=[sibling distance=10mm,font=\scriptsize,set style={{every node}+=[fill=yellow]}]
\tikzstyle{level 1}=[sibling distance=40mm,font=\footnotesize,set style={{every node}+=[fill=blue!15]}]
\node{Total}[edge from parent fork down]
 child {node {A}
   child {node {AX}}
   child {node {AY}}
   child {node {AZ}}
 }
 child {node {B}
   child {node {BX}}
   child {node {BY}}
   child {node {BZ}}
 }
 child {node {C}
   child {node {CX}}
   child {node {CY}}
   child {node {CZ}}
 };
\end{tikzpicture}}
\end{block}\vspace*{0.1cm}\fontsize{8}{8}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{B,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{C,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}=
    {\color{red}{\begin{pmatrix}
      1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1\\
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      0 & 0 & 0 & 0 & 0 & 0\\
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      0 & 0 & 0 & 0 & 0 & 0\\
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      0 & 0 & 0 & 0 & 0 & 0\\
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      0 & 0 & 0 & 0 & 0 & 0\\
      0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      0 & 0 & 0 \\
      0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      0 & 0 & 0 \\
      0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      0 & 0 & 0 \\
      0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      0 & 0 & 0 \\
      0 & 0 & 0 & 0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1}\\
      0 & 0 & 0 & 0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0}\\
      0 & 0 & 0 & 0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0}\\
      0 & 0 & 0 & 0 & 0 & 0 &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{0} &
      \only<2>{\textcolor[rgb]{0,0.6,0}}{1}\\
   \end{pmatrix}}}{\color{blue}{\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}\end{pmatrix}}}$}

\vspace*{10cm}

\begin{textblock}{3}(10.5,8)\fontsize{14}{15}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}

## Fast computation: hierarchies

\fontsize{13.6}{15}\sf
Think of the hierarchy as a tree of trees:
\begin{center}
\begin{tikzpicture}[scale=0.8]
%\tikzstyle{every node}=[ellipse,draw,inner sep=0.2pt,fill=red!15]
\tikzstyle[level distance=.1cm]
\tikzstyle[sibling distance=7cm]
%\tikzstyle{level 1}=[sibling distance=33mm,set style={{every node}+=[fill=blue!15]}]
\tikzstyle{level 1}=[sibling distance=33mm]
\node[ellipse,draw,inner sep=0.2pt,fill=red!15]{Total}[edge from parent fork down]
 child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_1$}
 }
 child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_2$}
 }
 child {node {\dots}
 }
 child {node[ellipse,draw,inner sep=0.2pt,fill=blue!15] {$T_K$}
 };
\end{tikzpicture}
\end{center}\pause
Then the summing matrix contains $k$ smaller summing matrices:

\begin{multicols}{2}
$\displaystyle
\bS = \left[\begin{array}{cccc}
{\bf1}'_{n_1}&{\bf1}'_{n_2}&\cdots&{\bf1}'_{n_K}\\
\bS_1&{{\bf0}}&\cdots&{\bf0}\\
{\bf0}&\bS_2&\cdots&{\bf0}\\
\vdots&\vdots&\ddots&\vdots\\
{\bf0}&{\bf0}&\cdots&\bS_K
\end{array}\right]$

\columnbreak

where ${\bf1}_n$ is an $n$-vector of ones and tree $T_i$ has $n_i$ terminal nodes.
\end{multicols}

\vspace*{10cm}

## Fast computation: hierarchies
\vspace*{-0.4cm}\fontsize{13}{15}\sf
$$
\!\bS'\!\bLambda\bS = \left[\begin{array}{cccc}
\bS_1'\bLambda_1\bS_1&{\bf0}&\cdots&{\bf0}\\
{\bf0}&\bS'_2\bLambda_2\bS_2&\cdots&{\bf0}\\
\vdots&\vdots&\ddots&\vdots\\
{\bf0}&{\bf0}&\cdots&\bS_K'\bLambda_K\bS_K
\end{array}\right] + \lambda_0\,\bJ_n
$$

* $\lambda_0$ is the top left element of $\bLambda$
* $\bLambda_k$ is a block of $\bLambda$, corresponding to tree $T_k$
* $\bJ_n$ is a matrix of ones
* $n=\sum_k n_k$

\pause
\alert{Now apply the Sherman-Morrison formula \dots}

\vspace*{10cm}

## Fast computation: hierarchies
\vspace*{-0.4cm}\fontsize{13}{15}\sf
$$\arraycolsep=0.1cm
\!(\bS'\!\bLambda\bS)^{-1} = \left[\begin{array}{cccc}
(\bS_1'\bLambda_1\bS_1)^{-1}&{\bf0}&\cdots&{\bf0}\\
{\bf0}&(\bS'_2\bLambda_2\bS_2)^{-1}&\cdots&{\bf0}\\
\vdots&\vdots&\ddots&\vdots\\
{\bf0}&{\bf0}&\cdots&(\bS_K'\bLambda_K\bS_K)^{-1}
\end{array}\right] - c\bS_0
$$

* $\bS_0$ can be partitioned into $K^2$ blocks, with the $(k,\ell)$ block
(of dimension $n_k\times n_\ell$) being
$(\bS_k'\bLambda_k\bS_k)^{-1}\bJ_{n_k,n_\ell} (\bS_\ell'\bLambda_\ell\bS_\ell)^{-1}$
* $\bJ_{n_k,n_\ell}$ is a $n_k\times n_\ell$ matrix of ones
* $\displaystyle c^{-1}=\lambda_0^{-1}+\sum_k {\bf1}_{n_k}' (\bS_k'\bLambda_k\bS_k)^{-1}{\bf1}_{n_k}$
* Each $\bS_k'\bLambda_k\bS_k$ can be inverted similarly
* $\bS'\!\bLambda\by$ can also be computed recursively

\only<2>{\begin{textblock}{6}(9.8,6)\fontsize{14}{15}\sf
\begin{alertblock}{}
The recursive calculations can be done in such a way that we never store any of the large matrices involved.
\end{alertblock}
\end{textblock}}
\only<2>{\placefig{15}{5.4}{width=1cm}{smiley}}

\vspace*{10cm}

## Fast computation: grouped data

\begin{block}{}
\begin{center}\small
\tikzstyle{every node}=[inner sep=2pt]\vspace*{-0.2cm}
\begin{tikzpicture}
    \matrix[ampersand replacement=\&,column sep=0.2cm] {
        \node[ellipse,draw,fill=yellow,font=\scriptsize,distance=1cm] {AX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {AY};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {AZ};~ \&
        \node[ellipse,draw,fill=blue!15] {A}; \\[0.cm]
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BY};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {BZ};~ \&
        \node[ellipse,draw,fill=blue!15] {B}; \\[0.cm]
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {CX};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {CY};~ \&
        \node[ellipse,draw,fill=yellow,font=\scriptsize] {CZ};~ \&
        \node[ellipse,draw,fill=blue!15] {C}; \\[0.05cm]
        \node[ellipse,draw,fill=blue!15] {X};~ \&
        \node[ellipse,draw,fill=blue!15] {Y};~ \&
        \node[ellipse,draw,fill=blue!15] {Z};~ \&
        \node[ellipse,draw,fill=red!15] {Total}; \\
};
\end{tikzpicture}
\end{center}
\end{block}\vspace*{0.0cm}\fontsize{8}{7}\sf

\hbox{$\by_{t}= \begin{pmatrix}
    y_t\\
    y_{A,t}\\
    y_{B,t}\\
    y_{C,t}\\
    y_{X,t}\\
    y_{Y,t}\\
    y_{Z,t}\\
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}
    \end{pmatrix}=
    \color{red}\begin{pmatrix}
                1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
                1 & 1 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
                0 & 0 & 0 & 1 & 1 & 1 & 0 & 0 & 0 \\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 1 & 1\\
                1 & 0 & 0 & 1 & 0 & 0 & 1 & 0 & 0 \\
                0 & 1 & 0 & 0 & 1 & 0 & 0 & 1 & 0 \\
                0 & 0 & 1 & 0 & 0 & 1 & 0 & 0 & 1 \\
                1 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
                0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 & 0  \\
                0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 & 0 \\
                0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 & 0 \\
                0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\
                0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 \\
                0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 \\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0\\
                0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1
             \end{pmatrix}\color{blue}\begin{pmatrix}
    y_{AX,t}\\
    y_{AY,t}\\
    y_{AZ,t}\\
    y_{BX,t}\\
    y_{BY,t}\\
    y_{BZ,t}\\
    y_{CX,t}\\
    y_{CY,t}\\
    y_{CZ,t}
    \end{pmatrix}$}

\begin{textblock}{3}(10.5,8)\fontsize{12}{13}\sf\colorbox[gray]{.8}{$\by_{t}=\color{red}\bS\color{blue}\bm{b}_{t}$}\end{textblock}

\vspace*{10cm}

## Fast computation: grouped data

$\displaystyle \bS=\begin{bmatrix}
\bm{1}_m'\otimes \bm{1}_n'\\
\bm{1}_m'\otimes \bI_n\\
\bI_m\otimes \bm{1}_n'\\
\bI_m\otimes \bI_n\\
\end{bmatrix}$\pause
\begin{block}{}
\centerline{$\bS'\!\bLambda\bS = \lambda_{00}\, \bm{J}_{mn} + (\bLambda_R\otimes  \bm{J}_{n}) + (\bm{J}_{m}\otimes \bLambda_C) +  \bLambda_U$}
\end{block}
\begin{itemize}
\item $\bLambda_R$, $\bLambda_C$ and $\bLambda_U$ are diagonal matrices corresponding to rows, columns and unaggregated series;
\item $\lambda_{00}$ corresponds to aggregate.
\end{itemize}

\begin{textblock}{7}(6,2.4)
$m=$ number of rows\\
$n=$ number of columns
\end{textblock}

## Fast computation: grouped data

\begin{block}{}
\centerline{$\displaystyle
(\bS\bLambda\bS)^{-1} = \bm{A} - \frac{\bm{A}\bm{1}_{mn}\bm{1}_{mn}'\bm{A}}
  {1/\lambda_{00} + \bm{1}_{mn}'\bm{A}\bm{1}_{mn}}$}
\end{block}\fontsize{12.5}{14}\sf\vspace*{-0.4cm}

$\bm{A} = \bLambda_U^{-1} - \bLambda_U^{-1}(\bm{J}_m\otimes \bm{D})\bLambda_U^{-1} - \bm{E}\bm{M}^{-1}\bm{E}'.$\newline
$\bm{D}$ is diagonal with elements \rlap{$d_j=\lambda_{0j}/(1+\lambda_{0j}\sum_i \lambda_{ij}^{-1})$.}\newline
$\bm{E}$ has $m\times m$ blocks where $\bm{e}_{ij}$ has $k$th element
$$
(\bm{e}_{ij})_k = \left \{ \begin{array}{lr}
\lambda_{i0}^{1/2} \lambda_{ik}^{-1} - \lambda_{i0}^{1/2} \lambda_{ik}^{-2}d_k,& i=j,\\
- \lambda_{j0}^{1/2}\lambda_{ik}^{-1}\lambda_{jk}^{-1}d_k,& i\neq j.
\end{array}\right .
$$
$\bm{M}$ is $m\times m$ with $(i,j)$ element
$$ (\bm{M})_{ij} =
\left \{ \begin{array}{lr}
1+\lambda_{i0}\sum_k \lambda_{ik}^{-1} - \lambda_{i0}\sum_k \lambda_{ik}^{-2}d_k,& i=j,\\
- \lambda_{i0}^{1/2}\lambda_{j0}^{1/2}\sum_k \lambda_{ik}^{-1}\lambda_{jk}^{-1}d_k,& i\neq j.
\end{array}\right .
$$

\only<2>{\begin{textblock}{4}(11.8,4)\fontsize{12}{13}\sf
\begin{alertblock}{}
Again, the calculations can be done in such a way that we never store any of the large matrices involved.
\end{alertblock}
\end{textblock}}
\only<2>{\placefig{15}{6.7}{width=1cm}{smiley}}

## Fast forecast reconciliation using linear models

Suppose $\hat{y}_{t,i} = \hat{\bm{\beta}}_{i}' \bm{x}_{t,i}$
with $\bm{x}_{t,i}= (1, x_{t,1,i},\dots,x_{t,p,i})$&nbsp; & &nbsp;\rlap{$\hat{\bm{y}}_i = (\hat{y}_{1,i}, \dots, \hat{y}_{T,i})$.}
\pause
\begin{align*}
\textcolor{blue}{\begin{pmatrix}
  \hat{\bm{y}}_1\\
  \hat{\bm{y}}_2\\
  \vdots\\
  \hat{\bm{y}}_n
  \end{pmatrix}} &=
  \textcolor{red}{\begin{pmatrix}
  \bm{X}_1 & 0        & \dots  & 0\\
  0        & \bm{X}_2 & \ddots & \vdots \\
  \vdots   & \ddots   & \ddots & 0\\
  0        & \dots    & 0      & \bm{X}_n
  \end{pmatrix}}
  \begin{pmatrix}
  \hat{\bm{\beta}}_1\\
  \hat{\bm{\beta}}_2\\
  \vdots\\
  \hat{\bm{\beta}}_n
\end{pmatrix},
&&\quad
  \bm{X}_i = \begin{pmatrix}
  1 & x_{1,i,1} & x_{1,i,2} & \dots & x_{1,i,p}\\
  1 & x_{2,i,1} & x_{2,i,2} & \dots & x_{2,i,p}\\
  \vdots & \vdots & \vdots & & \vdots \\
  1 & x_{T,i,1} & x_{T,i,2} & \dots & x_{T,i,p}
\end{pmatrix}
\end{align*}\pause
Then $\hat{\bm{B}} = (\textcolor{red}{\bm{X}}'\textcolor{red}{\bm{X}})^{-1} \textcolor{red}{\bm{X}}'\textcolor{blue}{\bm{Y}}$,\pause and\newline
$\hat{\bm{y}}_{t+h} = \bm{X}_{t+h}^* \hat{\bm{B}}$ with $\bm{X}^*_{t+h} =\text{diag}(\bm{x}_{t+h,i}', \dots, \bm{x}_{t+h,n}')$.\pause So
\begin{alertblock}{}
\centerline{$
    \tilde{\bm{y}}_{t+h} = \bm{S}(\bm{S}'\bm{W}_h\bm{S})^{-1}\bm{S}'\bm{W}_h
                            \hat{\bm{y}}_{t+h}
                         = \bm{S}(\bm{S}'\bm{W}_h\bm{S})^{-1}\bm{S}'\bm{W}_h
                            \bm{X}_{t+h}^* (\textcolor{red}{\bm{X}}'\textcolor{red}{\bm{X}})^{-1} \textcolor{red}{\bm{X}}'\textcolor{blue}{\bm{Y}}
$}
\end{alertblock}

\vspace*{10cm}


\nocite{hierarchical, fasthts, mint, lhf}
